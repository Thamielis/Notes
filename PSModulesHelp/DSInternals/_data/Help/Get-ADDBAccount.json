{
  "Synopsis": "Reads one or more accounts from a ntds.dit file, including secret attributes.",
  "Description": "Reads one or more accounts from an Active Directory database file. When provided with a boot key (AKA SysKey or system key), it also decrypts secret attributes.",
  "Parameters": [
    {
      "Name": null,
      "Type": null,
      "Description": "",
      "Required": false,
      "Position": 0,
      "Aliases": null,
      "DefaultValue": null,
      "Globbing": false,
      "PipelineInput": null,
      "variableLength": false
    }
  ],
  "Notes": [
    ""
  ],
  "CommandType": "Cmdlet",
  "Component": [
    null
  ],
  "Inputs": [
    "System.String",
    "System.Security.Principal.SecurityIdentifier",
    "System.Guid"
  ],
  "Outputs": [
    "DSInternals.Common.Data.DSAccount"
  ],
  "Links": [
    "https://github.com/MichaelGrafnetter/DSInternals/blob/master/Documentation/PowerShell/Get-ADDBAccount.md",
    null,
    null,
    null,
    null,
    null,
    null,
    null
  ],
  "Examples": [
    {
      "Title": "Example 1",
      "Markdown": "",
      "Code": "PS C:\\> Get-ADDBAccount -SamAccountName Administrator `\r\n                        -DatabasePath 'C:\\IFM Backup\\Active Directory\\ntds.dit'\r\n<# Sample Output:\r\nDistinguishedName: CN=Administrator,CN=Users,DC=contoso,DC=com\r\nSid: S-1-5-21-1236425271-2880748467-2592687428-500\r\nGuid: b3d02974-6b1c-484c-9103-fd2f60d592c4\r\nSamAccountName: Administrator\r\nSamAccountType: User\r\nUserPrincipalName:\r\nPrimaryGroupId: 513\r\nSidHistory:\r\nEnabled: True\r\nUserAccountControl: NormalAccount, PasswordNeverExpires\r\nSupportedEncryptionTypes: Default\r\nAdminCount: True\r\nDeleted: False\r\nLastLogonDate: 2/23/2015 10:27:18 AM\r\nDisplayName:\r\nGivenName:\r\nSurname:\r\nDescription: Built-in account for administering the computer/domain\r\nServicePrincipalName:\r\nSecurityDescriptor: DiscretionaryAclPresent, SystemAclPresent, DiscretionaryAclAutoInherited, SystemAclAutoInherited, DiscretionaryAclProtected, SelfRelative\r\nOwner: S-1-5-21-1236425271-2880748467-2592687428-512\r\nSecrets\r\n  NTHash:\r\n  LMHash:\r\n  NTHashHistory:\r\n  LMHashHistory:\r\n  SupplementalCredentials:\r\nKey Credentials:\r\nCredential Roaming\r\n  Created:\r\n  Modified:\r\n  Credentials:\r\n#>\r\nRetrieves information about a single account from an Active Directory database. Secret attributes are not decrypted as no boot key is provided."
    },
    {
      "Title": "Example 2",
      "Markdown": "",
      "Code": "PS C:\\> $key = Get-BootKey -SystemHiveFilePath 'C:\\IFM Backup\\registry\\SYSTEM'\r\nPS C:\\> Get-ADDBAccount -DistinguishedName: 'CN=Joe Smith,OU=Employees,DC=contoso,DC=com' `\r\n                        -BootKey $key `\r\n                        -DatabasePath 'C:\\IFM Backup\\Active Directory\\ntds.dit'\r\n<# Sample Output:\r\nDistinguishedName: CN=Joe Smith,OU=Employees,DC=contoso,DC=com\r\nSid: S-1-5-21-1236425271-2880748467-2592687428-1110\r\nGuid: 6fb7aca4-fe85-4dc5-9acd-b5b2529fe2bc\r\nSamAccountName: joe\r\nSamAccountType: User\r\nUserPrincipalName: joe@contoso.com\r\nPrimaryGroupId: 513\r\nSidHistory:\r\nEnabled: True\r\nUserAccountControl: NormalAccount, PasswordNeverExpires\r\nSupportedEncryptionTypes: Default\r\nAdminCount: False\r\nDeleted: False\r\nLastLogonDate:  2/23/2015 10:27:18 AM\r\nDisplayName: Joe Smith\r\nGivenName: Joe\r\nSurname: Smith\r\nDescription:\r\nServicePrincipalName:\r\nSecurityDescriptor: DiscretionaryAclPresent, SystemAclPresent, DiscretionaryAclAutoInherited, SystemAclAutoInherited, SelfRelative\r\nOwner: S-1-5-21-1236425271-2880748467-2592687428-512\r\nSecrets\r\n  NTHash: 92937945b518814341de3f726500d4ff\r\n  LMHash:\r\n  NTHashHistory:\r\n    Hash 01: 92937945b518814341de3f726500d4ff\r\n  LMHashHistory:\r\n    Hash 01: 30ce97eef1084cf1656cc4be70d68600\r\n  SupplementalCredentials:\r\n    ClearText:\r\n    NTLMStrongHash: 2c6d57beebeafdae65b3f40f2a0d5430\r\n    Kerberos:\r\n      Credentials:\r\n        DES_CBC_MD5\r\n          Key: 7f16bc4ada0b8a52\r\n      OldCredentials:\r\n      Salt: CONTOSO.COMjoe\r\n      Flags: 0\r\n    KerberosNew:\r\n      Credentials:\r\n        AES256_CTS_HMAC_SHA1_96\r\n          Key: cd541be0838c787b5c6a34d7b19274aee613545a0e6cc6f5ac5918d8a464d24f\r\n          Iterations: 4096\r\n        AES128_CTS_HMAC_SHA1_96\r\n          Key: 5c88972747bd454704c117ae52c474e4\r\n          Iterations: 4096\r\n        DES_CBC_MD5\r\n          Key: 7f16bc4ada0b8a52\r\n          Iterations: 4096\r\n      OldCredentials:\r\n      OlderCredentials:\r\n      ServiceCredentials:\r\n      Salt: CONTOSO.COMjoe\r\n      DefaultIterationCount: 4096\r\n      Flags: 0\r\n    WDigest:\r\n      Hash 01: 61fed940f0e8d03a49d3727f55800497\r\n      Hash 02: a1d54499dda6a6b5431f29a8d741a640\r\n      Hash 03: b6cdf00bc0c4578992f718de81251721\r\n      Hash 04: 61fed940f0e8d03a49d3727f55800497\r\n      Hash 05: a1d54499dda6a6b5431f29a8d741a640\r\n      Hash 06: 9a8991bd99763df2e37f1e1e67d71cc8\r\n      Hash 07: 61fed940f0e8d03a49d3727f55800497\r\n      Hash 08: 8a9fe94883c8ccf3bcfc6591ddd2288f\r\n      Hash 09: 8a9fe94883c8ccf3bcfc6591ddd2288f\r\n      Hash 10: 1b7b16b49ecd8d9d59c1d0db6fa2cc36\r\n      Hash 11: d4c24695cfa4dc3810a469d5efb8ecaf\r\n      Hash 12: 8a9fe94883c8ccf3bcfc6591ddd2288f\r\n      Hash 13: a5b8aa5088280298c8c27fa99dcaa1e3\r\n      Hash 14: d4c24695cfa4dc3810a469d5efb8ecaf\r\n      Hash 15: 1aa8e567622fe53d6fb36f1f34f12aaa\r\n      Hash 16: 1aa8e567622fe53d6fb36f1f34f12aaa\r\n      Hash 17: 2af425244079f8f45927c34fa115e45b\r\n      Hash 18: cf283a35102b820e25003b1ddf270221\r\n      Hash 19: b98c902c57449253e6f06b5d585866bd\r\n      Hash 20: 2a690b1eeda9cb8f3157a4a3ba0be9c3\r\n      Hash 21: af2654776d5f9f27f3283ecb0aa25011\r\n      Hash 22: af2654776d5f9f27f3283ecb0aa25011\r\n      Hash 23: ba6fe0513ed2a60ec253a41bbde6a837\r\n      Hash 24: 8bf5a67b598087be948e040f85c72b4d\r\n      Hash 25: 8bf5a67b598087be948e040f85c72b4d\r\n      Hash 26: aa5ff46d23a5c7ebd603e1793225350d\r\n      Hash 27: 656b6a7f5b52d05b3ce9168a2b7ac8ac\r\n      Hash 28: ae884c92ecd87e8d54f1844f09c5a519\r\n      Hash 29: a500a9e26afc9f817df8a07e15771577\r\nKey Credentials:\r\n  Usage=NGC, Source=ActiveDirectory, Device=1966d4da-14da-4581-a7a7-5e8e07e93ad9, Created=8/1/2019 10:53:12 PM, LastLogon=8/1/2019 10:53:12 PM\r\n  Usage=NGC, Source=ActiveDirectory, Device=cfe9a872-13ff-4751-a777-aec88c30a762, Created=8/1/2019 11:09:15 PM, LastLogon=8/1/2019 11:09:15 PM\r\nCredential Roaming\r\n  Created: 3/12/2017 9:15:56 AM\r\n  Modified: 3/13/2017 10:01:18 AM\r\n  Credentials:\r\n    DPAPIMasterKey: joe\\Protect\\S-1-5-21-1236425271-2880748467-2592687428-1110\\47070660-c259-4d90-8bc9-187605323450\r\n    DPAPIMasterKey: joe\\Protect\\S-1-5-21-1236425271-2880748467-2592687428-1110\\7fc19508-7b85-4a7c-9e5d-15f9e00e7ce5\r\n    CryptoApiCertificate: joe\\SystemCertificates\\My\\Certificates\\574E4687133998544C0095C7B348C52CD398182E\r\n    CNGCertificate: joe\\SystemCertificates\\My\\Certificates\\3B83BFA7037F6A79B3F3D17D229E1BC097F35B51\r\n    RSAPrivateKey: joe\\Crypto\\RSA\\S-1-5-21-1236425271-2880748467-2592687428-1110\\701577141985b6923998dcca035c007a_f8b7bbef-d227-4ac7-badd-3a238a7f741e\r\n    CNGPrivateKey: joe\\Crypto\\Keys\\E8F13C2BA0209401C4DFE839CD57375E26BBE38F\r\n#>\r\nRetrieves information about a single account from an Active Directory database. Secret attributes are decrypted using the provided boot key."
    },
    {
      "Title": "Example 3",
      "Markdown": "",
      "Code": "PS C:\\> $results = Get-ADDBAccount -DatabasePath '.\\Active Directory\\ntds.dit' `\r\n                                   -BootKey acdba64a3929261b04e5270c3ef973cf `\r\n                                   -All  |\r\n                   Test-PasswordQuality -WeakPasswordHashesSortedFile pwned-passwords-ntlm-ordered-by-hash-v8.txt\r\nPerforms an offline credential hygiene audit of AD database against HIBP."
    },
    {
      "Title": "Example 4",
      "Markdown": "",
      "Code": "PS C:\\> Get-ADDBAccount -All -DatabasePath ntds.dit -BootKey $key |\r\n            Format-Custom -View PwDump |\r\n            Out-File -FilePath users.pwdump -Encoding ascii\r\nExports NT and LM password hashes from an Active Directory database to a pwdump file."
    },
    {
      "Title": "Example 5",
      "Markdown": "",
      "Code": "PS C:\\> Get-ADDBBackupKey -DatabasePath '.\\ADBackup\\Active Directory\\ntds.dit' `\r\n                          -BootKey 0be7a2afe1713642182e9b96f73a75da |\r\n            Save-DPAPIBlob -DirectoryPath '.\\Output'\r\nPS C:\\> Get-ADDBAccount -All -DatabasePath '.\\ADBackup\\Active Directory\\ntds.dit' |\r\n            Save-DPAPIBlob -DirectoryPath '.\\Output'\r\nExtracts DPAPI backup keys and roamed credentials (certificates, private keys, and DPAPI master keys) from an Active Directory database file and saves them to the Output directory. Also creates a file called kiwiscript.txt that contains mimikatz commands needed to decrypt the private keys."
    },
    {
      "Title": "Example 6",
      "Markdown": "",
      "Code": "PS C:\\> Get-ADDBAccount -All -DatabasePath '.\\ADBackup\\Active Directory\\ntds.dit' |\r\n            Select-Object -ExpandProperty KeyCredentials |\r\n            Where-Object Usage -eq NGC |\r\n            Format-Table -View ROCA\r\n<# Sample Output:\r\n\r\nUsage IsWeak Source  DeviceId                             Created    Owner\r\n----- ------ ------  --------                             -------    -----\r\nNGC   True   AzureAD fd591087-245c-4ff5-a5ea-c14de5e2b32d 2017-07-19 CN=John Doe,CN=Users,DC=contoso,DC=com\r\nNGC   False  AD      1966d4da-14da-4581-a7a7-5e8e07e93ad9 2019-08-01 CN=Jane Doe,CN=Users,DC=contoso,DC=com\r\n#>\r\nLists weak public keys registered in Active Directory that were generated on ROCA-vulnerable TPMs."
    },
    {
      "Title": "Example 7",
      "Markdown": "",
      "Code": "PS C:\\> $dc = Get-ADDBDomainController -DatabasePath '.\\ADBackup\\Active Directory\\ntds.dit'\r\nPS C:\\> $adminSid = '{0}-500' -f $dc.DomainSid           \r\nPS C:\\> $account = Get-ADDBAccount -Sid $adminSid `\r\n                                   -DatabasePath '.\\ADBackup\\Active Directory\\ntds.dit' `\r\n                                   -BootKey 0be7a2afe1713642182e9b96f73a75da\r\nRetrieves information about a the the built-in Administrator account, even if it was renamed."
    }
  ]
}