<!DOCTYPE html>
<html>
<head>
<title>Deploy a Windows 10 multi-app kiosk with MEMCM and PowerShell.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/*!
  Theme: GitHub Dark
  Description: Dark theme as seen on github.com
  Author: github.com
  Maintainer: @Hirse
  Updated: 2021-05-15

  Outdated base version: https://github.com/primer/github-syntax-dark
  Current colors taken from GitHub's CSS
*/

.hljs {
  color: #c9d1d9;
  background: #0d1117;
}

.hljs-doctag,
.hljs-keyword,
.hljs-meta .hljs-keyword,
.hljs-template-tag,
.hljs-template-variable,
.hljs-type,
.hljs-variable.language_ {
  /* prettylights-syntax-keyword */
  color: #ff7b72;
}

.hljs-title,
.hljs-title.class_,
.hljs-title.class_.inherited__,
.hljs-title.function_ {
  /* prettylights-syntax-entity */
  color: #d2a8ff;
}

.hljs-attr,
.hljs-attribute,
.hljs-literal,
.hljs-meta,
.hljs-number,
.hljs-operator,
.hljs-variable,
.hljs-selector-attr,
.hljs-selector-class,
.hljs-selector-id {
  /* prettylights-syntax-constant */
  color: #79c0ff;
}

.hljs-regexp,
.hljs-string,
.hljs-meta .hljs-string {
  /* prettylights-syntax-string */
  color: #a5d6ff;
}

.hljs-built_in,
.hljs-symbol {
  /* prettylights-syntax-variable */
  color: #ffa657;
}

.hljs-comment,
.hljs-code,
.hljs-formula {
  /* prettylights-syntax-comment */
  color: #8b949e;
}

.hljs-name,
.hljs-quote,
.hljs-selector-tag,
.hljs-selector-pseudo {
  /* prettylights-syntax-entity-tag */
  color: #7ee787;
}

.hljs-subst {
  /* prettylights-syntax-storage-modifier-import */
  color: #c9d1d9;
}

.hljs-section {
  /* prettylights-syntax-markup-heading */
  color: #1f6feb;
  font-weight: bold;
}

.hljs-bullet {
  /* prettylights-syntax-markup-list */
  color: #f2cc60;
}

.hljs-emphasis {
  /* prettylights-syntax-markup-italic */
  color: #c9d1d9;
  font-style: italic;
}

.hljs-strong {
  /* prettylights-syntax-markup-bold */
  color: #c9d1d9;
  font-weight: bold;
}

.hljs-addition {
  /* prettylights-syntax-markup-inserted */
  color: #aff5b4;
  background-color: #033a16;
}

.hljs-deletion {
  /* prettylights-syntax-markup-deleted */
  color: #ffdcd7;
  background-color: #67060c;
}

.hljs-char.escape_,
.hljs-link,
.hljs-params,
.hljs-property,
.hljs-punctuation,
.hljs-tag {
  /* purposely ignored */
}

</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>
<link rel="stylesheet" href="file://term08/c%24/ProgramData/UniversalAutomation/Repository/KnowledgeBase/styles/github-markdown.css" type="text/css"><link rel="stylesheet" href="file://term08/c%24/ProgramData/UniversalAutomation/Repository/KnowledgeBase/styles/markdown.css" type="text/css">
<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body class="vscode-body vscode-dark">
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
  <div class="github-markdown-body github-markdown-auto">
    <div class="github-markdown-content">
      <h1 id="deploy-a-windows-10-multi-app-kiosk-with-microsoft-endpoint-manager-configuration-manager-memcm-and-powershell">Deploy a Windows 10 multi-app kiosk with Microsoft Endpoint Manager Configuration Manager (MEMCM) and PowerShell</h1>
<p>This post will cover how to create a maintainable Windows 10 multi-app kiosk with PowerShell and Configuration Manager and a PowerShell script that I wrote. I wrote a blog post here a couple of years ago about deploying <a href="https://4sysops.com/archives/windows-10-1809-kiosk-mode-with-an-ad-domain-account/">Windows 10 1809 in kiosk mode with an AD domain account</a>. Much has happened since then.</p>
<p>Contents</p>
<!-- vscode-markdown-toc -->
<ul>
<li><a href="#deploy-a-windows-10-multi-app-kiosk-with-microsoft-endpoint-manager-configuration-manager-memcm-and-powershell">Deploy a Windows 10 multi-app kiosk with Microsoft Endpoint Manager Configuration Manager (MEMCM) and PowerShell</a>
<ul>
<li><a href="#1--configuring-assigned-access">1.  Configuring Assigned Access</a></li>
<li><a href="#2-configure-auto-logon">2. Configure auto logon</a></li>
<li><a href="#3-deploying-the-kiosk-using-memcm">3. Deploying the kiosk using MEMCM</a></li>
<li><a href="#4-configure-kiosk-mode">4. Configure kiosk mode</a></li>
<li><a href="#5-reboot-after-osd">5. Reboot after OSD</a></li>
<li><a href="#6-writing-information-to-the-registry">6. Writing information to the registry</a></li>
<li><a href="#7-summary">7. Summary</a></li>
<li><a href="#8-subscribe-to-4sysops-newsletter">8. Subscribe to 4sysops newsletter</a></li>
</ul>
</li>
</ul>
<!-- vscode-markdown-toc-config
	numbering=true
	autoSave=true
	/vscode-markdown-toc-config -->
<!-- /vscode-markdown-toc -->
<hr>
<p>Kiosk machines, or single-purpose computers, are used in many scenarios and organizations. Kiosks come in several flavors, including single-purpose locked down kiosks and multi-app kiosks where you need to be able download files and work with them as well. They also need to be secure, as they are exposed in some use cases.</p>
<p>The result of the example script will look like the screen capture below.</p>
<p><img src="https://4sysops.com/wp-content/uploads/2020/10/Multi-app-kiosk-example.png" alt="Multi app kiosk example" title="Multi app kiosk example"></p>
<p>We also allow access to removable media and the Downloads folder, so if we want to save a file in Google Chrome and then open it in Excel, for example, it possible as shown below.</p>
<p><img src="https://4sysops.com/wp-content/uploads/2020/10/Open-in-Excel.png" alt="Open in Excel" title="Open in Excel"></p>
<p>The script will carry out the following configurations:</p>
<ul>
<li>Configure AutoLogon with a domain user</li>
<li>Configure the Start Menu</li>
<li>Add applications to the allow list</li>
<li>Allow saving/reading from the Downloads folder</li>
<li>Allow removable USB drives</li>
<li>Write kiosk information to the registry</li>
</ul>
<p>Here is the PowerShell script:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Name: MultiKiosk</span>
<span class="hljs-comment"># Authors: Jörgen Nilsson</span>

<span class="hljs-function">[<span class="hljs-type">CmdletBinding</span>()]</span>
<span class="hljs-keyword">Param</span>(
    [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$True</span>)]
    [<span class="hljs-built_in">string</span>]<span class="hljs-variable">$Username</span>,
    [<span class="hljs-type">Parameter</span>(<span class="hljs-type">Mandatory</span>=<span class="hljs-variable">$True</span>)]
    [<span class="hljs-built_in">string</span>]<span class="hljs-variable">$Password</span>
  )

<span class="hljs-comment"># Set values</span>
<span class="hljs-variable">$Version</span>=<span class="hljs-string">"1"</span>
<span class="hljs-variable">$RegKeyName</span> = <span class="hljs-string">"CCMEXECOSD"</span>
<span class="hljs-variable">$FullRegKeyName</span> = <span class="hljs-string">"HKLM:\SOFTWARE\"</span> + <span class="hljs-variable">$regkeyname</span> 
<span class="hljs-variable">$Domain</span>=<span class="hljs-string">"4sysops"</span>

<span class="hljs-comment"># Create Registry key </span>
<span class="hljs-built_in">New-Item</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$FullRegKeyName</span> <span class="hljs-literal">-type</span> Directory <span class="hljs-literal">-ErrorAction</span> SilentlyContinue

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Set-KioskMode</span></span> {

    <span class="hljs-variable">$DomainUser</span> = <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$Domain</span>)\<span class="hljs-variable">$</span>(<span class="hljs-variable">$UserName</span>)"</span>.TrimStart(<span class="hljs-string">'\'</span>)

    <span class="hljs-variable">$nameSpaceName</span>=<span class="hljs-string">"root\cimv2\mdm\dmmap"</span>
    <span class="hljs-variable">$className</span>=<span class="hljs-string">"MDM_AssignedAccess"</span>
    <span class="hljs-variable">$obj</span> = <span class="hljs-built_in">Get-CimInstance</span> <span class="hljs-literal">-Namespace</span> <span class="hljs-variable">$namespaceName</span> <span class="hljs-literal">-ClassName</span> <span class="hljs-variable">$className</span>
    
    <span class="hljs-built_in">Add-Type</span> <span class="hljs-literal">-AssemblyName</span> System.Web

    <span class="hljs-variable">$obj</span>.Configuration = [<span class="hljs-type">System.Web.HttpUtility</span>]::HtmlEncode(<span class="hljs-string">@"
    &lt;?xml version="1.0" encoding="utf-8" ?&gt;
    &lt;AssignedAccessConfiguration 
      xmlns="http://schemas.microsoft.com/AssignedAccess/2017/config"
      xmlns:v2="http://schemas.microsoft.com/AssignedAccess/201810/config"
      xmlns:v3="http://schemas.microsoft.com/AssignedAccess/2020/config"
    &gt;
      &lt;Profiles&gt;
        &lt;Profile Id="{9A2A490F-10F6-4764-974A-43B19E722C23}"&gt;
          &lt;AllAppsList&gt;
            &lt;AllowedApps&gt;
              &lt;App AppUserModelId="Windows.PrintDialog_cw5n1h2txyewy" /&gt;
              &lt;App DesktopAppPath="C:\Program Files (x86)\Google\Chrome\Application\chrome.exe" /&gt;
              &lt;App DesktopAppPath="C:\Program Files\Microsoft Office\root\Office16\Excel.exe" /&gt;
              &lt;App DesktopAppPath="C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe" /&gt;
            &lt;/AllowedApps&gt;
          &lt;/AllAppsList&gt;
          &lt;v2:FileExplorerNamespaceRestrictions&gt;
            &lt;v2:AllowedNamespace Name="Downloads"/&gt;
            &lt;v3:AllowRemovableDrives/&gt;
          &lt;/v2:FileExplorerNamespaceRestrictions&gt;
          &lt;StartLayout&gt;
            &lt;![CDATA[&lt;LayoutModificationTemplate xmlns:defaultlayout="http://schemas.microsoft.com/Start/2014/FullDefaultLayout" xmlns:start="http://schemas.microsoft.com/Start/2014/StartLayout" Version="1" xmlns="http://schemas.microsoft.com/Start/2014/LayoutModification"&gt;
                          &lt;LayoutOptions StartTileGroupCellWidth="6" /&gt;
                          &lt;DefaultLayoutOverride&gt;
                            &lt;StartLayoutCollection&gt;
                              &lt;defaultlayout:StartLayout GroupCellWidth="6"&gt;
                                &lt;start:Group Name="Product"&gt;
                                  &lt;start:DesktopApplicationTile Size="2x2" Column="0" Row="0" DesktopApplicationLinkPath="%ALLUSERSPROFILE%\Microsoft\Windows\Start Menu\Programs\Google Chrome.lnk" /&gt;
                                  &lt;start:DesktopApplicationTile Size="2x2" Column="2" Row="0" DesktopApplicationLinkPath="%ALLUSERSPROFILE%\Microsoft\Windows\Start Menu\Programs\Microsoft Edge.lnk" /&gt;
                                  &lt;start:DesktopApplicationTile Size="2x2" Column="4" Row="0" DesktopApplicationLinkPath="%ALLUSERSPROFILE%\Microsoft\Windows\Start Menu\Programs\Excel.lnk" /&gt;
                                &lt;/start:Group&gt;
                              &lt;/defaultlayout:StartLayout&gt;
                            &lt;/StartLayoutCollection&gt;
                          &lt;/DefaultLayoutOverride&gt;
                        &lt;/LayoutModificationTemplate&gt;
                    ]]&gt;
          &lt;/StartLayout&gt;
          &lt;Taskbar ShowTaskbar="true"/&gt;
        &lt;/Profile&gt;
      &lt;/Profiles&gt;
      &lt;Configs&gt;
        &lt;Config&gt;
          &lt;Account&gt;<span class="hljs-variable">$DomainUser</span>&lt;/Account&gt;
          &lt;DefaultProfile Id="{9A2A490F-10F6-4764-974A-43B19E722C23}"/&gt;
        &lt;/Config&gt;
      &lt;/Configs&gt;
    &lt;/AssignedAccessConfiguration&gt;
"@</span>)

<span class="hljs-built_in">Set-CimInstance</span> <span class="hljs-literal">-CimInstance</span> <span class="hljs-variable">$obj</span>

}

<span class="hljs-variable">$Code</span> = <span class="hljs-string">@'
Add-Type @"
using System;
using System.Collections.Generic;
using System.Runtime.InteropServices;
using System.Text;
 
namespace PInvoke.LSAUtil {
    public class LSAutil {
        [StructLayout (LayoutKind.Sequential)]
        private struct LSA_UNICODE_STRING {
            public UInt16 Length;
            public UInt16 MaximumLength;
            public IntPtr Buffer;
        }
 
        [StructLayout (LayoutKind.Sequential)]
        private struct LSA_OBJECT_ATTRIBUTES {
            public int Length;
            public IntPtr RootDirectory;
            public LSA_UNICODE_STRING ObjectName;
            public uint Attributes;
            public IntPtr SecurityDescriptor;
            public IntPtr SecurityQualityOfService;
        }
 
        private enum LSA_AccessPolicy : long {
            POLICY_VIEW_LOCAL_INFORMATION = 0x00000001L,
            POLICY_VIEW_AUDIT_INFORMATION = 0x00000002L,
            POLICY_GET_PRIVATE_INFORMATION = 0x00000004L,
            POLICY_TRUST_ADMIN = 0x00000008L,
            POLICY_CREATE_ACCOUNT = 0x00000010L,
            POLICY_CREATE_SECRET = 0x00000020L,
            POLICY_CREATE_PRIVILEGE = 0x00000040L,
            POLICY_SET_DEFAULT_QUOTA_LIMITS = 0x00000080L,
            POLICY_SET_AUDIT_REQUIREMENTS = 0x00000100L,
            POLICY_AUDIT_LOG_ADMIN = 0x00000200L,
            POLICY_SERVER_ADMIN = 0x00000400L,
            POLICY_LOOKUP_NAMES = 0x00000800L,
            POLICY_NOTIFICATION = 0x00001000L
        }
 
        [DllImport ("advapi32.dll", SetLastError = true, PreserveSig = true)]
        private static extern uint LsaStorePrivateData (
            IntPtr policyHandle,
            ref LSA_UNICODE_STRING KeyName,
            ref LSA_UNICODE_STRING PrivateData
        );
 
        [DllImport ("advapi32.dll", SetLastError = true, PreserveSig = true)]
        private static extern uint LsaOpenPolicy (
            ref LSA_UNICODE_STRING SystemName,
            ref LSA_OBJECT_ATTRIBUTES ObjectAttributes,
            uint DesiredAccess,
            out IntPtr PolicyHandle
        );
 
        [DllImport ("advapi32.dll", SetLastError = true, PreserveSig = true)]
        private static extern uint LsaNtStatusToWinError (
            uint status
        );
 
        [DllImport ("advapi32.dll", SetLastError = true, PreserveSig = true)]
        private static extern uint LsaClose (
            IntPtr policyHandle
        );
 
        [DllImport ("advapi32.dll", SetLastError = true, PreserveSig = true)]
        private static extern uint LsaFreeMemory (
            IntPtr buffer
        );
 
        private LSA_OBJECT_ATTRIBUTES objectAttributes;
        private LSA_UNICODE_STRING localsystem;
        private LSA_UNICODE_STRING secretName;
 
        public LSAutil (string key) {
            if (key.Length == 0) {
                throw new Exception ("Key lenght zero");
            }
 
            objectAttributes = new LSA_OBJECT_ATTRIBUTES ();
            objectAttributes.Length = 0;
            objectAttributes.RootDirectory = IntPtr.Zero;
            objectAttributes.Attributes = 0;
            objectAttributes.SecurityDescriptor = IntPtr.Zero;
            objectAttributes.SecurityQualityOfService = IntPtr.Zero;
 
            localsystem = new LSA_UNICODE_STRING ();
            localsystem.Buffer = IntPtr.Zero;
            localsystem.Length = 0;
            localsystem.MaximumLength = 0;
 
            secretName = new LSA_UNICODE_STRING ();
            secretName.Buffer = Marshal.StringToHGlobalUni (key);
            secretName.Length = (UInt16) (key.Length * UnicodeEncoding.CharSize);
            secretName.MaximumLength = (UInt16) ((key.Length + 1) * UnicodeEncoding.CharSize);
        }
 
        private IntPtr GetLsaPolicy (LSA_AccessPolicy access) {
            IntPtr LsaPolicyHandle;
            uint ntsResult = LsaOpenPolicy (ref this.localsystem, ref this.objectAttributes, (uint) access, out LsaPolicyHandle);
            uint winErrorCode = LsaNtStatusToWinError (ntsResult);
            if (winErrorCode != 0) {
                throw new Exception ("LsaOpenPolicy failed: " + winErrorCode);
            }
            return LsaPolicyHandle;
        }
 
        private static void ReleaseLsaPolicy (IntPtr LsaPolicyHandle) {
            uint ntsResult = LsaClose (LsaPolicyHandle);
            uint winErrorCode = LsaNtStatusToWinError (ntsResult);
            if (winErrorCode != 0) {
                throw new Exception ("LsaClose failed: " + winErrorCode);
            }
        }
 
        private static void FreeMemory (IntPtr Buffer) {
            uint ntsResult = LsaFreeMemory (Buffer);
            uint winErrorCode = LsaNtStatusToWinError (ntsResult);
            if (winErrorCode != 0) {
                throw new Exception ("LsaFreeMemory failed: " + winErrorCode);
            }
        }
 
        public void SetSecret (string value) {
            LSA_UNICODE_STRING lusSecretData = new LSA_UNICODE_STRING ();
 
            if (value.Length &gt; 0) {
                //Create data and key
                lusSecretData.Buffer = Marshal.StringToHGlobalUni (value);
                lusSecretData.Length = (UInt16) (value.Length * UnicodeEncoding.CharSize);
                lusSecretData.MaximumLength = (UInt16) ((value.Length + 1) * UnicodeEncoding.CharSize);
            } else {
                //Delete data and key
                lusSecretData.Buffer = IntPtr.Zero;
                lusSecretData.Length = 0;
                lusSecretData.MaximumLength = 0;
            }
 
            IntPtr LsaPolicyHandle = GetLsaPolicy (LSA_AccessPolicy.POLICY_CREATE_SECRET);
            uint result = LsaStorePrivateData (LsaPolicyHandle, ref secretName, ref lusSecretData);
            ReleaseLsaPolicy (LsaPolicyHandle);
 
            uint winErrorCode = LsaNtStatusToWinError (result);
            if (winErrorCode != 0) {
                throw new Exception ("StorePrivateData failed: " + winErrorCode);
            }
        }
    }
}
"@
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" -Name "DefaultUserName" -Value "%USERNAME%"
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" -Name "DefaultDomainName" -Value "%DOMAINNAME%"
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" -Name "AutoAdminLogon" -Value "1"
[PInvoke.LSAUtil.LSAutil]::new("DefaultPassword").SetSecret("%PASSWORD%")
Unregister-ScheduledTask -TaskName "CreateAutologon" -Confirm:$false -EA SilentlyContinue
Restart-Computer -Force
'@</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Create-Task</span> <span class="hljs-params">(<span class="hljs-variable">$Argument</span>)</span></span> {

    <span class="hljs-variable">$Schedule</span> = <span class="hljs-built_in">New-Object</span> <span class="hljs-literal">-ComObject</span> <span class="hljs-string">"Schedule.Service"</span>
    <span class="hljs-variable">$Schedule</span>.Connect(<span class="hljs-string">'localhost'</span>)
    <span class="hljs-variable">$Folder</span> = <span class="hljs-variable">$Schedule</span>.GetFolder(<span class="hljs-string">'\'</span>)

    <span class="hljs-variable">$task</span> = <span class="hljs-variable">$Schedule</span>.NewTask(<span class="hljs-number">0</span>)
    <span class="hljs-variable">$task</span>.RegistrationInfo.Author = <span class="hljs-string">"Onevinn"</span>
    <span class="hljs-variable">$task</span>.RegistrationInfo.Description = <span class="hljs-string">"CreateAutologon"</span>

    <span class="hljs-variable">$action</span> = <span class="hljs-variable">$task</span>.Actions.Create(<span class="hljs-number">0</span>)
    <span class="hljs-variable">$action</span>.Path = <span class="hljs-string">"PowerShell.exe"</span>
    <span class="hljs-variable">$action</span>.Arguments = <span class="hljs-string">"<span class="hljs-variable">$Argument</span>"</span>

    <span class="hljs-variable">$task</span>.Settings.StartWhenAvailable = <span class="hljs-variable">$true</span>

    <span class="hljs-variable">$trigger</span> = <span class="hljs-variable">$task</span>.Triggers.Create(<span class="hljs-number">8</span>)
    <span class="hljs-variable">$trigger</span>.Delay = <span class="hljs-string">"PT120S"</span>


    <span class="hljs-variable">$result</span> = <span class="hljs-variable">$Folder</span>.RegisterTaskDefinition(<span class="hljs-string">"CreateAutologon"</span>, <span class="hljs-variable">$task</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"SYSTEM"</span>, <span class="hljs-variable">$null</span>, <span class="hljs-number">5</span>)
}

<span class="hljs-variable">$Code</span> = <span class="hljs-variable">$Code</span>.Replace(<span class="hljs-string">"%USERNAME%"</span>, <span class="hljs-variable">$Username</span>)
<span class="hljs-variable">$Code</span> = <span class="hljs-variable">$Code</span>.Replace(<span class="hljs-string">"%DOMAINNAME%"</span>, <span class="hljs-variable">$Domain</span>)
<span class="hljs-variable">$Code</span> = <span class="hljs-variable">$Code</span>.Replace(<span class="hljs-string">"%PASSWORD%"</span>, <span class="hljs-variable">$Password</span>)

<span class="hljs-variable">$bytes</span> = [<span class="hljs-type">System.Text.Encoding</span>]::Unicode.GetBytes(<span class="hljs-variable">$Code</span>)
<span class="hljs-variable">$b64</span> = [<span class="hljs-type">System.Convert</span>]::ToBase64String(<span class="hljs-variable">$bytes</span>)

<span class="hljs-built_in">Set-KioskMode</span>

Create<span class="hljs-literal">-Task</span> <span class="hljs-literal">-Argument</span> <span class="hljs-string">"-EncodedCommand <span class="hljs-variable">$</span>(<span class="hljs-variable">$b64</span>)"</span>

<span class="hljs-comment"># Set registry values to be used later</span>
<span class="hljs-built_in">new-itemproperty</span> <span class="hljs-variable">$FullRegKeyName</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">"Kiosk Version"</span> <span class="hljs-literal">-Value</span> <span class="hljs-variable">$Version</span> <span class="hljs-literal">-Type</span> STRING <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> SilentlyContinue | <span class="hljs-built_in">Out-Null</span>
<span class="hljs-built_in">new-itemproperty</span> <span class="hljs-variable">$FullRegKeyName</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">"UserName"</span> <span class="hljs-literal">-Value</span> <span class="hljs-variable">$username</span> <span class="hljs-literal">-Type</span> STRING <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> SilentlyContinue | <span class="hljs-built_in">Out-Null</span>

</div></code></pre>
<h2 id="1-a-nameconfiguringassignedaccessaconfiguring-assigned-access">1.  <a name='ConfiguringAssignedAccess'></a>Configuring Assigned Access</h2>
<p>We configure the assigned access parts in the script in the XML that we configure in the script. More information about what we can configure can be found <a href="https://docs.microsoft.com/en-us/windows/configuration/kiosk-xml">here</a> and <a href="https://docs.microsoft.com/en-us/windows/configuration/lock-down-windows-10-to-specific-apps">here</a>. Examples are included.</p>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">AssignedAccessConfiguration</span> 
   <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://schemas.microsoft.com/AssignedAccess/2017/config"</span>
   <span class="hljs-attr">xmlns:v2</span>=<span class="hljs-string">"http://schemas.microsoft.com/AssignedAccess/201810/config"</span>
   <span class="hljs-attr">xmlns:v3</span>=<span class="hljs-string">"http://schemas.microsoft.com/AssignedAccess/2020/config"</span>
\&gt;</span>
</div></code></pre>
<p>The AllowedApps section lists all apps that can run. In the back end, this includes AppLocker rules that are created on the machine, so troubleshooting in a third-party application calls more binaries. These binaries also need to be listed to be allowed to run. Everything that is not on the list is blocked.</p>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">AllowedApps</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">App</span> <span class="hljs-attr">AppUserModelId</span>=<span class="hljs-string">"Windows.PrintDialog_cw5n1h2txyewy"</span> /&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">App</span> <span class="hljs-attr">DesktopAppPath</span>=<span class="hljs-string">"C:\Program Files (x86)\Google\Chrome\Application\chrome.exe"</span> /&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">App</span> <span class="hljs-attr">DesktopAppPath</span>=<span class="hljs-string">"C:\Program Files\Microsoft Office\root\Office16\Excel.exe"</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">App</span> <span class="hljs-attr">DesktopAppPath</span>=<span class="hljs-string">"C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">AllowedApps</span>&gt;</span>
</div></code></pre>
<p>Allowing folder access and removable media is done by using the V2 and V3 schemas that we defined earlier in the XML file, as shown in the example below. It is very easy to add new folders if necessary.</p>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">v2:FileExplorerNamespaceRestrictions</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">v2:AllowedNamespace</span> <span class="hljs-attr">Name</span>=<span class="hljs-string">"Downloads"</span>/&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">v3:AllowRemovableDrives</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">v2:FileExplorerNamespaceRestrictions</span>&gt;</span>
</div></code></pre>
<h2 id="2-a-nameconfigureautologonaconfigure-auto-logon">2. <a name='Configureautologon'></a>Configure auto logon</h2>
<p>In my previous post, I used Group Policy preferences to configure AutoLogon, which stores the username and password in clear text in the registry. I also used AutoLogon.exe, which is a Microsoft tool that configures AutoLogon since it stores passwords as LSA secrets and not in clear text in the registry. In the sample script posted here, there is a section rewritten by my colleague, Johan Schrewelius, which does the same thing that AutoLogon.exe does. It also adds a scheduled task that is used to configure AutoLogon, as all attempts to configure it during OS deployment are cleared by the OOBE part of the setup.</p>
<h2 id="3-a-namedeployingthekioskusingmemcmadeploying-the-kiosk-using-memcm">3. <a name='DeployingthekioskusingMEMCM'></a>Deploying the kiosk using MEMCM</h2>
<p>To deploy the kiosk script using Configuration Manager, I have a kiosk group in my task sequence that includes the following steps:</p>
<p><img src="https://4sysops.com/wp-content/uploads/2020/10/Task-sequence-steps.png" alt="Task sequence steps" title="Task sequence steps"></p>
<p>Task sequence steps</p>
<p>For the kiosk computers, I added them to a collection with the variables shown below:</p>
<p><img src="https://4sysops.com/wp-content/uploads/2020/10/Collection-variables.png" alt="Collection variables" title="Collection variables"></p>
<p>Collection variables</p>
<p>The variables are picked up by the PowerShell script in the task sequence when we deploy the computer. In my script, I hardcoded the domain name, which could easily have been a variable as well. It is set early in the script:</p>
<pre class="hljs"><code><div><span class="hljs-variable">$Domain</span>=<span class="hljs-string">"4sysops"</span>
</div></code></pre>
<p>Let's look at the three different steps in the task sequence. Move to correct OUI use a simple PowerShell script to move the computer to my Kiosk OU to make sure that the correct Group Policies are applied. It is then executed using an account with the correct permissions to move the account in AD.</p>
<p><img src="https://4sysops.com/wp-content/uploads/2020/10/Move-to-correct-OU-600x509.png" alt="Move to correct OU">
Move to correct OU</p>
<h2 id="4-a-nameconfigurekioskmodeaconfigure-kiosk-mode">4. <a name='Configurekioskmode'></a>Configure kiosk mode</h2>
<p>This step executes the PowerShell script that configures the computer in Kiosk mode. The variables passed to the script are -Username and -Password, as shown below.</p>
<p><img src="https://4sysops.com/wp-content/uploads/2020/10/Configure-Kiosk-Mode-600x510.png" alt="Configure Kiosk Mode">
Configure Kiosk Mode</p>
<h2 id="5-a-namerebootafterosdareboot-after-osd">5. <a name='RebootafterOSD'></a>Reboot after OSD</h2>
<p>This step sets the task sequence variable &quot;SMSTSPOSTaction,&quot; which reboots the computer after OSD is finished. There will be dual reboots before the computer is in kiosk mode, one caused by the SMSTSPostaction and one caused by the scheduled task that is configured. AutoLogon.</p>
<p><img src="https://4sysops.com/wp-content/uploads/2020/10/Reboot-after-OSD.png" alt="Reboot after OSD" title="Reboot after OSD">
Reboot after OSD</p>
<h2 id="6-a-namewritinginformationtotheregistryawriting-information-to-the-registry">6. <a name='Writinginformationtotheregistry'></a>Writing information to the registry</h2>
<p>We also write information to the registry about the account that was used and the version of the kiosk configuration. This comes in handy if and when we need to update the machine's kiosk configuration.</p>
<p><img src="https://4sysops.com/wp-content/uploads/2020/10/Registry-value.png" alt="Registry value" title="Registry value">
Registry value</p>
<p>The name of the registry key can be modified in the script at the very beginning by changing the variable to your preference.</p>
<pre class="hljs"><code><div><span class="hljs-variable">$RegKeyName</span> = <span class="hljs-string">"CCMEXECOSD"</span>
</div></code></pre>
<h2 id="7-a-namesummaryasummary">7. <a name='Summary'></a>Summary</h2>
<p>If you are still deploying kiosk machines and locking them down with Group Policy, AppLocker, and scripts, I highly recommend that you check out assigned access mode. It is so simple to deploy and lock down straight off and is locked down much more tightly than many kiosk setups I have seen.</p>
<h2 id="8-a-namesubscribeto4sysopsnewsletterasubscribe-to-4sysops-newsletter">8. <a name='Subscribeto4sysopsnewsletter'></a>Subscribe to 4sysops newsletter</h2>
<p>In my next post, I will explain how you can <a href="https://4sysops.com/archives/update-windows-10-multi-app-kiosk-using-run-script-in-microsoft-endpoint-configuration-manager-memcm/">update the Windows 10 kiosk</a>.</p>

    </div>
  </div>
</body>
</html>
