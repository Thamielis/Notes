Today I want to show you how easily you can get the list of unhealthy SCOM agents using PowerShell. In this example I used **Microsoft.Windows.Computer** class for scanning all of those SCOM agents which availability state equals false:

<table><tbody><tr><td><p>1</p><p>2</p><p>3</p></td><td><div><p><code>$Agent</code> <code>= </code><code>Get-SCOMClass</code> <code>-Name</code> <code>Microsoft.Windows.Computer</code></p><p><code>$Objects</code> <code>= </code><code>Get-SCOMMonitoringObject</code> <code>-class</code><code>:</code><code>$Agent</code> <code>| </code><code>Where-Object</code> <code>{</code><code>$_</code><code>.IsAvailable –eq </code><code>$false</code><code>}</code></p></div></td></tr></tbody></table>

In results **$SCOMArray** you will find additional information like “Primary Management Server”, “last modified date” and check if it’s “in maintenance mode”. Script needs to be run on SCOM server.

**Final script:**

<table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p></td><td><div><p><code>Import-Module</code> <code>OperationsManager</code></p><p><code>$Agent</code> <code>= </code><code>Get-SCOMClass</code> <code>-Name</code> <code>Microsoft.Windows.Computer</code></p><p><code>$Objects</code> <code>= </code><code>Get-SCOMMonitoringObject</code> <code>-class</code><code>:</code><code>$Agent</code> <code>| </code><code>Where-Object</code> <code>{</code><code>$_</code><code>.IsAvailable –eq </code><code>$false</code><code>}</code></p><p><code>$SCOMArray</code> <code>= @()</code></p><p><code>ForEach</code> <code>(</code><code>$Object</code> <code>in</code> <code>$Objects</code><code>)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Write-Host</code> <code>"Processing: "</code> <code>-NoNewline</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Write-host</code> <code>$object</code><code>.DisplayName</code> <code>-ForegroundColor</code> <code>Green</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Mgmt</code> <code>= (</code><code>Get-SCOMAgent</code> <code>-Name</code> <code>$object</code><code>.DisplayName).PrimaryManagementServerName</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$SCOMObject</code> <code>= </code><code>New-Object</code> <code>PSCustomObject</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$SCOMObject</code> <code>| </code><code>Add-Member</code> <code>-MemberType</code> <code>NoteProperty</code> <code>-Name</code> <code>"Server"</code> <code>-Value</code> <code>$object</code><code>.DisplayName</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$SCOMObject</code> <code>| </code><code>Add-Member</code> <code>-MemberType</code> <code>NoteProperty</code> <code>-Name</code> <code>"AD Site"</code> <code>-Value</code> <code>$object</code><code>.</code><code>"[Microsoft.Windows.Computer].ActiveDirectorySite"</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$SCOMObject</code> <code>| </code><code>Add-Member</code> <code>-MemberType</code> <code>NoteProperty</code> <code>-Name</code> <code>"Primary Management Server"</code> <code>-Value</code> <code>$Mgmt</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$SCOMObject</code> <code>| </code><code>Add-Member</code> <code>-MemberType</code> <code>NoteProperty</code> <code>-Name</code> <code>"Last Modified"</code> <code>-Value</code> <code>$object</code><code>.LastModified</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$SCOMObject</code> <code>| </code><code>Add-Member</code> <code>-MemberType</code> <code>NoteProperty</code> <code>-Name</code> <code>"IsAvailable"</code> <code>-Value</code> <code>$object</code><code>.IsAvailable</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$SCOMObject</code> <code>| </code><code>Add-Member</code> <code>-MemberType</code> <code>NoteProperty</code> <code>-Name</code> <code>"Health state"</code> <code>-Value</code> <code>$object</code><code>.HealthState</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$SCOMObject</code> <code>| </code><code>Add-Member</code> <code>-MemberType</code> <code>NoteProperty</code> <code>-Name</code> <code>"In Maintenance Mode"</code> <code>-Value</code> <code>$object</code><code>.InMaintenanceMode</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$SCOMArray</code> <code>+= </code><code>$SCOMObject</code></p><p><code>}</code></p><p><code>$SCOMArray</code> <code>| </code><code>Format-Table</code> <code>-AutoSize</code> <code>-Wrap</code></p><p><code>$SCOMArray</code> <code>| </code><code>Out-GridView</code> <code>-Title</code> <code>"Unhealthy SCOM Agents"</code></p><p><code>$SCOMArray</code> <code>| </code><code>Export-Csv</code> <code>-Path</code> <code>"C:\users\$env:USERNAME\desktop\results.csv"</code> <code>-NoTypeInformation</code> <code>-Force</code></p></div></td></tr></tbody></table>

SCOM Cmdltes can be found [here](https://technet.microsoft.com/en-us/library/hh920227(v=sc.20).aspx).