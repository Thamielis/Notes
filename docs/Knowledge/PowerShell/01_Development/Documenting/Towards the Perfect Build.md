---
created: 2025-05-02T10:14:30 (UTC +02:00)
tags: []
source: https://www.red-gate.com/simple-talk/development/dotnet-development/towards-the-perfect-build/
author: Matt Wrock
---

# Towards the Perfect Build - Simple Talk

---
About two and a half years ago I wrote a [series of blog posts](http://www.mattwrock.com/post/2009/09/30/The-Perfect-Build-Part-1.aspx) documenting the work my team had done to automate our build process. We had completed a migration from [VSS](http://msdn.microsoft.com/en-us/library/3h0544kx(v=vs.80).aspx) to [SVN](http://subversion.apache.org/) and used a combination of [nAnt](http://nant.sourceforge.net/) and [CruiseControl](http://cruisecontrol.sourceforge.net/) to facilitate continuous integration and push-button deployments to any of our environments including production.

Over the last couple months, I’ve had the opportunity to put together an automated deployment process for my current organization at Microsoft. Throughout my career, I’ve worked on a few projects that were essentially a rewrite of a similar project that I had worked on in the past for a different employer. What I love about this type of project is that it is a great opportunity to do so many things better. I can remember those architectural decisions I had made and regretted; but was too far in to easily change (usually a smell of an architectural weakness itself). Well now I can avoid them and approach it from the angle I wished I had before. This was an opportunity to do the same thing with the system for automating our builds.

Although I was pleased with the system that I had put together previously, I now had better tools at my disposal. I still think nAnt and CruiseControl are fine tools, but now I’m using [PowerShell](http://technet.microsoft.com/en-us/library/bb978526.aspx) with [PSake](https://github.com/psake/psake) instead of nAnt, [TeamCity](http://www.jetbrains.com/teamcity/) instead of CruiseControl and our source code is now in [Mercurial](https://www.mercurial-scm.org/) instead of SVN. The other major difference between the system I’m building now and the one I had worked on before is that this system also includes the automation of server setup and configuration, bringing a clean OS to a full functioning application node serving any tier in the app (web, database, admin, etc.)

This article is intended to provide an overview of the new system without diving into the detail.

## **Do you really need an automated build and deployment system?**

Yes. You do.

You may be thinking that, while an automated system sounds neat, you simply don’t have time to build one. While I tend to be very pragmatic in my approach to software architecture, I definitely see automated deployments as being essential rather than a luxury. The reason I say this is that by using manual, rather than automated, deployments, you will cause more time to be lost in the mechanics of deploying and there is far more risk of a bad deployment and there is more difficulty and time spent in troubleshooting deployments.

Often, teams do not recognize the value of automated deployments until they experience them. Once they work with one, they can’t imagine going back. With automated build and deployments, the drama of deployments is reduced to a simple routine task and teams have more time to focus on building features. The business has more confidence that their features will move forward reliably and consistently. If you want to release more often and perhaps extend continuous integration to continuous deployment, you simply must automate the deployment process.

## **If they are so important, why did it take you over two years to start building one?**

This is a fair question. I don’t intend to enumerate the political reasons, of which there are many. That will have to wait for my memoire due out in 2042, “My life, a love song,” please keep an eye out for that one.

Throughout my tenure in the MSDN/Technet organization at Microsoft, deployments have been managed by a combination of test and a “build team” in the Ops group. Although I have certainly been vocal in pushing for more automation, I was wary of forcing the pace of change because other people do most of the work and that there was resistance from some to the idea of automating the process. There were certainly pain points along the way. There was a lot of ceremony involved in preparing for a deployment and in scheduling “hot fixes” with the build team. When there were problems with a deployment, it could sometimes be difficult to determine where things went wrong.

Recently, we made a transition to a new offshore vendor company. One of their responsibilities would be deployments and setting up new environments. Because these were mostly done manually, the logistics involved were often communicated verbally and via large step by step Word documents.

Without going into the details, a lot fell through the cracks as the new team came on-board. I do not fault the people on this team, I wouldn’t expect anyone to be able to build an environment for a complex app that they have never worked on before based on a few phone conversations and a SharePoint wiki. Our environment setups and deployments suddenly started having problems. Because a large part of the code I am involved with spans over several apps, I am often approached when things go wrong here and before long I found myself spending most of my time troubleshooting and fixing environments and their deployments. It soon became crystal clear that, until an automated system was in place, this would continue to stand in the way of me getting real feature work done; and instead of whining and complaining about it, I decided to just do it.

## **What exactly does a automated build and deployment system do?**

For the system I set out to build, the following key components are included:

1.  Application compilation and packaging
2.  Deployment of application packages to various environments
3.  Bootstrap scripts for setting up a new server or environment

The last one has inspired a new personal side project, [Autobox](http://autobox.codeplex.com/), that sets out to automate the building of a developer machine (or any kind of personal machine) from bare OS via a single command line. After all, if I can create a test server with SQL Server, app fabric caching, various Windows services, and web applications along with all the file permissions and firewall rules involved, certainly I can create my own machine with all my preferred apps and settings ready to go.

Lets examine each of these individually.

### **Application compilation and packaging**

This is, essentially, the process that transforms the raw application bits with all of its code files, static assets, SQL scripts, configuration files, and other application-specific files into a zip file that can be consumed by the deployment scripts. This package, in our case, is typically composed of a directory for each application tier. Here is the package for our Galleries application:

![1481-clip_image001.png](https://www.red-gate.com/simple-talk/wp-content/uploads/imported/1481-clip_image001.png)

The packaging process is responsible for the actual compilation which typically involves a call to MsBuild and which invokes the appropriate MsBuild tasks from the original Visual Studio solution. In addition to transforming the source files to compiled DLLs, the packaging process copies everything that is needed in order to deploy the application into a coherent directory structure and nothing more. This typically includes PowerShell scripts and various command line tools that run SQL scripts to update the database with any schema changes, adds metadata to lookup tables or migrates old data to conform to new schema or logic. It may also include scripts responsible for transforming web.config and app.configs  with settings that are appropriate for the environment.

This first step of the build and deployment process had been in place for quite some time, so I just had to make some minor tweaks here and there. The individual application teams in my group are responsible for keeping the packaging scripts up to date and it is wired into our continuous Integration process. Every push of source code to the central Mercurial repository forces our build server, Teamcity, to invoke a set of scripts that include compilation, running unit tests and finally packaging. TeamCity then saves the zipped package and makes it available to the deployment scripts. If you are familiar with Teamcity, you know that this is the build “Artifacts.”

### **Deployment of application packages to various environments**

Here is where my work largely started. Until recently, we had a script that TeamCity would invoke twice a day which would collect the packages of each app and aggregate them into another package for each deployable environment. This uses the “dependencies” feature of TeamCity. In your TeamCity build settings, you can state that your build is dependent on another build or group of builds. In our case and as illustrated below, we had six depedent builds that would be aggregated into a master build package. The “artifacts” of the last successful build of each dependent build is unzipped and placed in a named directory relative to the working directory of the master build. For example, the deployable artifacts of the Forums application are unzipped and placed in a directory named Forums that the master build script can reference via “forums\\…”

[![1481-clip_image002-620x234.png](https://www.red-gate.com/simple-talk/wp-content/uploads/imported/1481-clip_image002-620x234.png)](https://www.red-gate.com/simple-talk/wp-content/uploads/imported/1481-image002Big.png)

So in our case, we would have application packages for Forums, Search, Profile and various internal services as seen above and these would all be rolled into a single 7z file for each environment including test, staging, production, etc. This packaging script was also responsible for the final transformation of the configuration files. It would merge those settings that are specific to each environment into the web and app configs so that the final package, say prod-7791.7z (7791 being the build number), had the exact web and app configs that would end up in production.

Well this would take two and a half hours to run. Back in the day, it was fairly fast; but as environments got added, the process took longer and longer. It would then take the build team a couple hours to take this package and deploy its bits to each server, run the database upgrade scripts, stop and restart services, smoke test, etc. This could become more and more painful the closer we got to release. This was because, as or when the developers would fix bugs, it could take one to two days before they received feedback from test on those bugs.

Revamping this was fairly straightforward. I rewrote this script to transform the configs for only a single environment which it would receive via a command parameter from TeamCity. I created a separate build config in TeamCity to make this very clear:

[![1481-clip_image003-620x270.png](https://www.red-gate.com/simple-talk/wp-content/uploads/imported/1481-clip_image003-620x270.png)](https://www.red-gate.com/simple-talk/wp-content/uploads/imported/1481-image003Big.png)

Each of these build configurations run the exact same script but they each pass different command line arguments to the build script so as to indicate their environment. Also, some are wired to different Version Control branches. For example, our Int (Integration) environment builds off of the Release Candidate branch while the others build off of Trunk. Finally there is an “Ad Hoc” config where anyone can run a custom build with custom command line parameters. If the Ad Hoc build fails no one is notified and we don’t get particularly alarmed. Here is how the command line parameters are wired up for custom builds in TeamCity:

[![1481-clip_image004-620x543.png](https://www.red-gate.com/simple-talk/wp-content/uploads/imported/1481-clip_image004-620x543.png)](https://www.red-gate.com/simple-talk/wp-content/uploads/imported/1481-image004Big.png)

The script is a normal PowerShell script that gets called via psake. [Psake](http://en.wikipedia.org/wiki/Psake) provides a very nice PowerShell-based container for running builds. Think of it as an alternative to writing an MSBuild script. While MSBuild is more XML-based and very declarative in nature, PSake allows you to script out all of your build tasks in PowerShell. This makes a lot of sense for the type of things that a build script does – such as copying files around. I’m not going to dive into a PSake tutorial here but here is a snippet of my PSake script:

<table><tbody><tr><td data-settings="hide"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p></div></td><td><div><p><span>properties</span><span> </span><span>{</span></p><p><span></span><span>$</span><span>current</span><span> </span><span>=</span><span> </span><span>Resolve</span><span>-</span><span>Path</span><span> </span><span>.</span><span>\</span><span>default</span><span>.</span><span>ps1</span><span> </span><span>|</span><span> </span><span>Split</span><span>-</span><span>Path</span></p><p><span></span><span>$</span><span>path</span><span> </span><span>=</span><span> </span><span>$</span><span>current</span></p><p><span></span><span>$</span><span>BuildNumber</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span></span><span>$</span><span>ConfigDrop</span><span> </span><span>=</span><span> </span><span>".\_configs"</span></p><p><span></span><span>$</span><span>WebDrop</span><span> </span><span>=</span><span> </span><span>"HTTP"</span></p><p><span></span><span>$</span><span>Environment</span><span> </span><span>=</span><span> </span><span>"DEFAULT"</span></p><p><span></span><span>$</span><span>configVariables</span><span> </span><span>=</span><span> </span><span>New</span><span>-</span><span>Object</span><span> </span><span>System</span><span>.</span><span>Collections</span><span>.</span><span>Queue</span></p><p><span>}</span></p><p><span>Include</span><span> </span><span>.</span><span>\</span><span>psake</span><span>\</span><span>teamcity</span><span>.</span><span>ps1</span></p><p><span>task </span><span>default</span><span> </span><span>-</span><span>depends </span><span>Package</span></p><p><span>task </span><span>Configs</span><span> </span><span>-</span><span>depends </span><span>Copy</span><span>-</span><span>readme</span><span>,</span><span> </span><span>SetupEnvironment</span><span>,</span><span> </span><span>Configure</span><span>-</span><span>Social</span><span>,</span><span></span></p><p><span></span><span>Configure</span><span>-</span><span>StoApps</span><span>,</span><span> </span><span>Configure</span><span>-</span><span>Services</span><span>,</span><span> </span><span>Configure</span><span>-</span><span>SocialServices</span></p><p><span>task </span><span>Package</span><span> </span><span>-</span><span>depends </span><span>SetupEnvironment</span><span>,</span><span> </span><span>Clean</span><span>,</span><span> </span><span>Configs</span><span>,</span><span> </span><span>Database</span><span>,</span><span> </span><span>preparesearch</span><span>,</span><span></span></p><p><span></span><span>SocialSites</span><span>,</span><span> </span><span>StoApps</span><span>,</span><span> </span><span>SocialServices</span><span>,</span><span> </span><span>StopServices</span><span>,</span><span> </span><span>Services</span><span>,</span><span> </span><span>CopyConfigs</span><span>,</span><span></span></p><p><span></span><span>StartServices</span><span>,</span><span> </span><span>FlushRequestReduce</span><span>,</span><span> </span><span>RestartIIS</span><span>,</span><span> </span><span>RestartAppFabric</span><span>,</span><span> </span><span>TestPages</span><span>,</span><span></span></p><p><span></span><span>CleanEnvironment</span></p><p><span>TaskSetup</span><span> </span><span>{</span></p><p><span></span><span>TeamCity</span><span>-</span><span>ReportBuildStart</span><span> </span><span>"Starting task $($psake.context.Peek().currentTaskName)"</span></p><p><span>}</span></p><p><span>TaskTearDown</span><span> </span><span>{</span></p><p><span></span><span>TeamCity</span><span>-</span><span>ReportBuildFinish</span><span> </span><span>"Finishing task $($psake.context.Peek().currentTaskName)"</span></p><p><span>}</span></p><p><span>Task</span><span> </span><span>SetupEnvironment</span><span> </span><span>{</span></p><p><span></span><span>.</span><span>\</span><span>Utilities</span><span>\</span><span>EnvironmentSetup</span><span>.</span><span>ps1</span><span> </span><span>$</span><span>current</span><span> </span><span>$</span><span>Environment</span><span> </span><span>$</span><span>configVariables</span></p><p><span>}</span></p></div></td></tr></tbody></table>

This is not any kind of special scripting language. It is normal PowerShell. PSake provides a PowerShell module which exposes several functions like Task, Properties, etc. Many of these take script blocks as parameters. The [PSake module](https://github.com/psake/psake/blob/master/src/psake.psm1) really is not very large and therefore it does not take much investment to understand what it does and what functionality it provides. It really does not provide much “functionality” at all, in terms of utility methods, but it provides a very nice framework for organizing the various parts of your build script and for specifying dependencies.

The snippet above is the beginning of my deployment script. The Properties section defines and sets script-wide variables that can be overridden via command line parameters when calling PSake. Next are my tasks. Tasks might actually do something like the **SetupEnvironment** task at the bottom. Or they might alias a group of tasks to be run in a specific order like the default, Configs and Package tasks. If you are familiar with MSBuild, these are simply the equivalent of MSBuild targets.

When you call PSake, you can tell it to run a specific task or, if you do not, it will run the default task. Even though I am only including a small part of my script here, it is easy to tell what the deployment script does by simply looking at the dependencies of the default task. It first sets up the environment by calling another PowerShell script that will set a bunch of global environment variables specific to the Environment property. It performs a task to clean traces of any previous build, it transforms the configs, and runs the database scripts. Then it executes several tasks that copy different directories to the web server, stops some windows services, copies the services code, starts the services, restarts IIS, runs some quick tests to make sure the apps are loading and finally cleans up after itself.

One nice thing about this script is that it does not use any kind of remoting. This can be important in some environments. The script can be run directly from the build agent (the server running the TeamCity Build Agent service) and target any environment. Instead of remoring, it requires that the Service Identity under which TeamCity runs is an administrator on the target web servers and SQL Servers. To give you a glimpse into what is going on here, I specify all of the server names that are specific to each environment in a config file named after the environment. So our Next (daily build) environment has a file called Next.ps1 that among many other things contains:

<table><tbody><tr><td data-settings="hide"></td><td><div><p><span>$</span><span>global</span><span>:</span><span>WebServers</span>&nbsp;&nbsp;&nbsp;&nbsp;<span> </span><span>=</span><span> </span><span>"RR1STOCSAVWB18"</span><span>,</span><span> </span><span>"RR1STOCSAVWB17"</span></p><p><span>$</span><span>global</span><span>:</span><span>ServicesServer</span>&nbsp;<span>=</span><span> </span><span>"RR1STOCSAVWB17"</span></p></div></td></tr></tbody></table>

Then my RestartIIS task looks like this:

<table><tbody><tr><td data-settings="hide"></td><td><div><p><span>Task</span><span> </span><span>RestartIIS</span><span> </span><span>{</span></p><p><span></span><span>Restart</span><span>-</span><span>IIS</span><span> </span><span>$</span><span>global</span><span>:</span><span>WebServers</span></p><p><span>}</span></p><p><span>function </span><span>Restart</span><span>-</span><span>IIS</span><span>(</span><span>[</span><span>array</span><span>]</span><span> </span><span>$</span><span>servers</span><span>)</span><span> </span><span>{</span></p><p><span></span><span>foreach</span><span> </span><span>(</span><span>$</span><span>server </span><span>in</span><span> </span><span>$</span><span>servers</span><span>)</span><span> </span><span>{</span></p><p><span></span><span>.</span><span>\</span><span>Utilities</span><span>\</span><span>RemoteService</span><span>.</span><span>ps1</span><span> </span><span>(</span><span>$</span><span>server</span><span> </span><span>-</span><span>split</span><span> </span><span>"\\"</span><span>)</span><span>[</span><span>0</span><span>]</span><span> </span><span>restart</span><span> </span><span>-</span><span>service</span><span> </span><span>"W3SVC"</span></p><p><span></span><span>}</span></p><p><span>}</span></p></div></td></tr></tbody></table>

RemoteServices.ps1 contains a bunch of functions to make working with services on remote servers less painful.

##  **Did the deployment succeed?**

At any point in the scripts, if an error occurs, the build will fail. However, I also want to have some way to quickly check each application and ensure they can at least load. It is very possible that  the build script will complete just fine, but there may be something in the latest app code or some change to the environment that would cause an application to fail. If this happens, I want to know which app failed, fail the build and provide straight forward reporting to testers to discover where things broke down. Yes, each app build has its own set of unit tests. Most apps have thousands but there are a multitude of issues, both code-related and server or network-related, that can slip through the cracks and cause the app to fail.

At the end of every deployment, a series of URLs are “pinged” and expected to return a 200 HTTP status code. Currently we have 28 URLs in our tests. Now a big reason for overhauling this system was to make it faster. This meant that we were concerned that we would profoundly slow the build process by launching a bunch of app URLs. To try to make this as efficient as possible, we use PowerShell jobs to multi-thread the HTTP requests and set a 5 minute timeout that will automatically fail all tests that do not complete before the timeout.

Here is the testing script:

<table><tbody><tr><td data-settings="hide"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p></div></td><td><div><p><span>task</span><span> </span><span>TestPages</span><span> </span><span>-</span><span>depends</span><span> </span><span>SetupEnvironment</span><span> </span><span>{</span></p><p><span></span><span>.</span><span> </span><span>.</span><span>\</span><span>tests</span><span>.</span><span>ps1</span></p><p><span></span><span>Wait</span><span>-</span><span>Job</span><span> </span><span>-</span><span>Job</span><span> </span><span>$</span><span>openRequests</span><span> </span><span>-</span><span>Timeout</span><span> </span><span>300</span></p><p><span></span><span>foreach</span><span> </span><span>(</span><span>$</span><span>request </span><span>in</span><span> </span><span>$</span><span>openRequests</span><span>)</span><span> </span><span>{</span></p><p><span></span><span>TeamCity</span><span>-</span><span>TestStarted</span><span> </span><span>$</span><span>request</span><span>.</span><span>Name</span></p><p><span></span><span>$</span><span>jobOutput</span><span> </span><span>=</span><span> </span><span>(</span><span>Receive</span><span>-</span><span>Job</span><span> </span><span>$</span><span>request</span><span>)</span></p><p><span></span><span>if</span><span>(</span><span>$</span><span>jobOutput</span><span> </span><span>-</span><span>is</span><span> </span><span>[</span><span>system</span><span>.</span><span>array</span><span>]</span><span>)</span><span> </span><span>{</span><span>$</span><span>jobOutput</span><span> </span><span>=</span><span> </span><span>$</span><span>jobOutput</span><span>[</span><span>-</span><span>1</span><span>]</span><span>}</span></p><p><span></span><span>$</span><span>testParts</span><span> </span><span>=</span><span> </span><span>$</span><span>jobOutput</span><span> </span><span>-</span><span>split</span><span> </span><span>" ::: "</span></p><p><span></span><span>if</span><span>(</span><span>$</span><span>testParts</span><span>.</span><span>Length</span><span> </span><span>-</span><span>eq</span><span> </span><span>2</span><span>)</span><span> </span><span>{</span></p><p><span></span><span>$</span><span>testMessage</span><span>=</span><span>$</span><span>testParts</span><span>[</span><span>1</span><span>]</span></p><p><span></span><span>$</span><span>testTime</span><span>=</span><span>$</span><span>testParts</span><span>[</span><span>0</span><span>]</span></p><p><span></span><span>}</span></p><p><span></span><span>else</span><span> </span><span>{</span></p><p><span></span><span>$</span><span>testMessage</span><span>=</span><span>$</span><span>testParts</span><span>[</span><span>0</span><span>]</span></p><p><span></span><span>$</span><span>testTime</span><span>=</span><span>300</span></p><p><span></span><span>}</span></p><p><span></span><span>if</span><span>(</span><span>$</span><span>request</span><span>.</span><span>state</span><span> </span><span>-</span><span>ne</span><span> </span><span>"Completed"</span><span>)</span><span> </span><span>{</span></p><p><span></span>&nbsp;&nbsp;<span>TeamCity</span><span>-</span><span>TestFailed</span><span> </span><span>$</span><span>request</span><span>.</span><span>Name</span><span> </span><span>"Timeout"</span><span> </span><span>"Test did not complete within timeout."</span></p><p><span></span><span>}</span></p><p><span></span><span>Remove</span><span>-</span><span>Job</span><span> </span><span>$</span><span>request</span><span> </span><span>-</span><span>Force</span></p><p><span></span><span>if</span><span> </span><span>(</span><span>$</span><span>testMessage</span><span> </span><span>-</span><span>like</span><span> </span><span>"Failed*"</span><span>)</span><span> </span><span>{</span></p><p><span></span><span>TeamCity</span><span>-</span><span>TestFailed</span><span> </span><span>$</span><span>request</span><span>.</span><span>Name</span><span> </span><span>"Did not Recive a 200 Response"</span><span> </span><span>$</span><span>testMessage</span></p><p><span></span><span>}</span></p><p><span></span><span>TeamCity</span><span>-</span><span>TestFinished</span><span> </span><span>$</span><span>request</span><span>.</span><span>Name</span><span> </span><span>$</span><span>testTime</span></p><p><span></span><span>}</span></p><p><span>}</span></p><p><span>function </span><span>Ping</span><span> </span><span>(</span><span>[</span><span>string</span><span>]</span><span> </span><span>$</span><span>pingUrl</span><span>)</span><span> </span><span>{</span></p><p><span></span><span>$</span><span>jobArray</span><span> </span><span>=</span><span> </span><span>@</span><span>(</span><span>)</span></p><p><span></span><span>$</span><span>job</span><span> </span><span>=</span><span> </span><span>Start</span><span>-</span><span>Job</span><span> </span><span>-</span><span>scriptblock</span><span> </span><span>{</span><span>param</span><span>(</span><span>$</span><span>url</span><span>)</span></p><p><span></span><span>$</span><span>host</span><span>.</span><span>UI</span><span>.</span><span>RawUI</span><span>.</span><span>BufferSize</span><span> </span><span>=</span><span> </span><span>New</span><span>-</span><span>Object</span><span> </span><span>System</span><span>.</span><span>Management</span><span>.</span><span>Automation</span><span>.</span><span>Host</span><span>.</span><span>Size</span><span>(</span><span>8192</span><span>,</span><span>50</span><span>)</span></p><p><span></span><span>$</span><span>ms</span><span> </span><span>=</span><span> </span><span>(</span><span>Measure</span><span>-</span><span>Command</span><span> </span><span>{</span></p><p><span></span><span>$</span><span>web</span><span>=</span><span>[</span><span>net</span><span>.</span><span>HTTPwebrequest</span><span>]</span><span>::</span><span>create</span><span>(</span><span>$</span><span>url</span><span>)</span></p><p><span></span><span>$</span><span>web</span><span>.</span><span>AllowAutoRedirect</span><span> </span><span>=</span><span> </span><span>$</span><span>true</span></p><p><span></span><span>$</span><span>web</span><span>.</span><span>PreAuthenticate</span><span> </span><span>=</span><span> </span><span>$</span><span>true</span></p><p><span></span><span>$</span><span>web</span><span>.</span><span>Timeout</span><span> </span><span>=</span><span> </span><span>300000</span></p><p><span></span><span>$</span><span>systemWebProxy</span><span> </span><span>=</span><span> </span><span>[</span><span>net</span><span>.</span><span>webrequest</span><span>]</span><span>::</span><span>GetSystemWebProxy</span><span>(</span><span>)</span></p><p><span></span><span>$</span><span>systemWebProxy</span><span>.</span><span>Credentials</span><span> </span><span>=</span><span> </span><span>[</span><span>net</span><span>.</span><span>CredentialCache</span><span>]</span><span>::</span><span>DefaultCredentials</span></p><p><span></span><span>$</span><span>web</span><span>.</span><span>Proxy</span><span> </span><span>=</span><span> </span><span>$</span><span>systemWebProxy</span></p><p><span></span><span>$</span><span>web</span><span>.</span><span>Credentials</span><span> </span><span>=</span><span> </span><span>[</span><span>net</span><span>.</span><span>CredentialCache</span><span>]</span><span>::</span><span>DefaultCredentials</span></p><p><span></span><span>try</span><span> </span><span>{</span></p><p><span></span><span>$</span><span>resp</span><span>=</span><span>$</span><span>web</span><span>.</span><span>GetResponse</span><span>(</span><span>)</span></p><p><span></span><span>}</span></p><p><span></span><span>catch</span><span> </span><span>[</span><span>System</span><span>.</span><span>Net</span><span>.</span><span>WebException</span><span>]</span><span>{</span></p><p><span></span><span>$</span><span>resp</span><span>=</span><span>$</span><span>_</span><span>.</span><span>Exception</span><span>.</span><span>Response</span></p><p><span></span><span>$</span><span>outerMessage</span><span> </span><span>=</span><span> </span><span>$</span><span>_</span><span>.</span><span>Exception</span><span>.</span><span>Message</span></p><p><span></span><span>$</span><span>innerMessage</span><span> </span><span>=</span><span> </span><span>$</span><span>_</span><span>.</span><span>Exception</span><span>.</span><span>InnerException</span></p><p><span></span><span>}</span></p><p><span></span><span>}</span><span>)</span><span>.</span><span>TotalMilliseconds</span></p><p><span></span><span>$</span><span>status</span><span> </span><span>=</span><span> </span><span>[</span><span>int</span><span>]</span><span>$</span><span>resp</span><span>.</span><span>StatusCode</span></p><p><span></span><span>if</span><span> </span><span>(</span><span>$</span><span>status</span><span> </span><span>-</span><span>ne</span><span> </span><span>200</span><span>)</span><span> </span><span>{</span></p><p><span></span><span>$</span><span>badServer</span><span> </span><span>=</span><span> </span><span>$</span><span>resp</span><span>.</span><span>Headers</span><span>[</span><span>"Server"</span><span>]</span></p><p><span></span><span>Write</span><span>-</span><span>Output</span><span> </span><span>"$ms ::: Failed to retrieve $url in $ms ms with status code:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $status from server: $badServer"</span></p><p><span></span><span>Write</span><span>-</span><span>Output</span><span> </span><span>$</span><span>outerMessage</span></p><p><span></span><span>Write</span><span>-</span><span>Output</span><span> </span><span>$</span><span>innerMessage</span></p><p><span></span><span>}</span></p><p><span></span><span>else</span><span> </span><span>{</span></p><p><span></span><span>Write</span><span>-</span><span>Output</span><span> </span><span>"$ms ::: Succeeded retrieving $url in $ms ms"</span></p><p><span></span><span>}</span></p><p><span></span><span>}</span><span> </span><span>-</span><span>name</span><span> </span><span>"$pingUrl"</span><span> </span><span>-</span><span>ArgumentList</span><span> </span><span>$</span><span>pingUrl</span></p><p><span></span><span>$</span><span>jobArray</span><span> </span><span>+=</span><span> </span><span>$</span><span>Job</span></p><p><span></span><span>return</span><span> </span><span>$</span><span>jobArray</span></p><p><span>}</span></p></div></td></tr></tbody></table>

The individual test URLs are in the dot sourced tests.ps1:

<table><tbody><tr><td data-settings="hide"></td><td><div><p><span>$</span><span>openRequests</span><span> </span><span>+=</span><span> </span><span>Ping</span><span> </span><span>"HTTP://$global:ServicesUrl/ChameleonService/Api.svc"</span></p><p><span>$</span><span>openRequests</span><span> </span><span>+=</span><span> </span><span>Ping</span><span> </span><span>"HTTP://$global:AdminUrl/ChameleonAdmin/"</span></p><p><span>$</span><span>openRequests</span><span> </span><span>+=</span><span> </span><span>Ping</span><span> </span><span>"HTTP://$global:ServicesUrl/SearchProviderServices/SearchProviderService.svc"</span></p><p><span>$</span><span>openRequests</span><span> </span><span>+=</span><span> </span><span>Ping</span><span> </span><span>"HTTP://$global:ProfileApiUrl/ProfileApi/v1/profile/displayname/vamcalerts"</span></p><p><span>$</span><span>openRequests</span><span> </span><span>+=</span><span> </span><span>Ping </span><span>HTTP</span><span>:</span><span>//$global:UserCardLoaderUrl</span></p><p><span>.</span><span>.</span><span>.</span></p></div></td></tr></tbody></table>

An interesting thing to note here is the use of the functions beginning with TeamCity-. These are functions coming from a [module](https://github.com/psake/psake-contrib/blob/master/teamcity.psm1) provided by the [pake-contrib project](https://github.com/psake/psake-contrib) that exposes several functions that allow you to interact with TeamCity’s messaging infrastructure. The functions I am using here create standard output messages formatted in such a way that TeamCity will treat them like test output reporting when a test starts and finishes, as well as if it succeeded or failed, and how long it took. What is really nice about all of this is that now these tests light up in TeamCity’s test reporting:

 [![1481-clip_image005-620x134.png](https://www.red-gate.com/simple-talk/wp-content/uploads/imported/1481-clip_image005-620x134.png)](https://www.red-gate.com/simple-talk/wp-content/uploads/imported/1481-image005Big.png)  
I can zoom in on my failed tests to see why they failed:

[![1481-clip_image006-620x185.png](https://www.red-gate.com/simple-talk/wp-content/uploads/imported/1481-clip_image006-620x185.png)](https://www.red-gate.com/simple-talk/wp-content/uploads/imported/1481-image006Big.png)

Pretty slick eh?

## **Bootstrap scripts for setting up a new server or environment**

In my original [Perfect Build series](http://www.mattwrock.com/post/2009/09/30/The-Perfect-Build-Part-1.aspx) of blog posts, I did not include automation around setting up servers or environments. However one of the habits I picked up from the teams I work with at Microsoft is the inclusion of a build.bat file at the root of every source code repo that can build a development environment from scratch. In the past I had never followed this practice. I had not really used PowerShell and was not aware of all the possibilities available. Basically, you can do pretty much anything in PowerShell. I’ll admit that there is a learning curve involved but it is well worth climbing it. Being able to fire up a development environment for an app with a single command has proven to be a major time saver and a great way to “document” application requirements.

Now, it’s one thing to get a development environment up and running, but getting a true server environment up can be more challenging. Since many organizations don’t give developers access to the server environments, setting these up often becomes a responsibility of server operations. This may involve dev sending ops instructions, or sitting down with an ops engineer to get a server up and running. A lot of time can be lost here and it’s easy to forget to properly update these instructions. I have, personally, spent an aggregate of weeks troubleshooting environments that have not been set up correctly.

One solution that is commonly employed here is to use VM images. Once you get an environment set up the way it is supposed to be inside of a VM, take a snapshot and simply apply that snapshot whenever you need to setup a new server. I don’t like this approach. It is too easy for VM images to become stale and they don’t serve well to “document” all of the requirements of an application. The fact is, just about anything can be scripted in PowerShell and, in my opinion, if it cannot be scripted then you have probably made a poor choice in technology. PowerShell scripts can replace “deployment documents” or server setup documents. They should be readable by both developers and server support engineers. Even if one is not well versed in PowerShell, I believe any technical professional should at least be able to read a PowerShell script and deduce the gist of what it is doing.

For my applications, I put together a script, again in psake format, that can build any application tier from a bare OS. It can also build a complete environment on a stand alone server. To provide an idea of what my script can do, here is the head of the psake script:

<table><tbody><tr><td data-settings="hide"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p></div></td><td><div><p><span>properties</span><span> </span><span>{</span></p><p><span></span><span>$</span><span>currentDir</span><span> </span><span>=</span><span> </span><span>Resolve</span><span>-</span><span>Path</span><span> </span><span>.</span><span>\</span><span>cleansetup</span><span>.</span><span>ps1</span><span> </span><span>|</span><span> </span><span>Split</span><span>-</span><span>Path</span></p><p><span></span><span>$</span><span>profile</span><span> </span><span>=</span><span> </span><span>"$currentDir\CommApps\Profile"</span></p><p><span></span><span>$</span><span>forums</span><span> </span><span>=</span><span> </span><span>"$currentDir\CommApps\Forums"</span></p><p><span></span><span>$</span><span>search</span><span> </span><span>=</span><span> </span><span>"$currentDir\CommApps\Search"</span></p><p><span></span><span>$</span><span>chameleon</span><span> </span><span>=</span><span> </span><span>"$currentDir\CommApps\Chameleon"</span></p><p><span></span><span>$</span><span>configVariables</span><span> </span><span>=</span><span> </span><span>New</span><span>-</span><span>Object</span><span> </span><span>System</span><span>.</span><span>Collections</span><span>.</span><span>Queue</span></p><p><span></span><span>IF</span><span> </span><span>(</span><span> </span><span>TEST</span><span>-</span><span>PATH</span><span> </span><span>d</span><span>:</span><span>\</span><span>)</span><span> </span><span>{</span><span> </span><span>$</span><span>HTTPShare</span><span>=</span><span>"d:\HTTP"</span><span> </span><span>}</span><span> </span><span>else</span><span> </span><span>{</span><span> </span><span>$</span><span>HTTPShare</span><span>=</span><span>"c:\HTTP"</span><span> </span><span>}</span></p><p><span></span><span>$</span><span>env</span><span> </span><span>=</span><span> </span><span>"test"</span></p><p><span></span><span>$</span><span>appFabricShareName</span><span> </span><span>=</span><span> </span><span>"velocity"</span></p><p><span></span><span>$</span><span>buildServerIdentity</span><span> </span><span>=</span><span> </span><span>"Redmond\Idiotbild"</span></p><p><span></span><span>$</span><span>domain</span><span> </span><span>=</span><span> </span><span>"redmond.corp.microsoft.com"</span></p><p><span></span><span>$</span><span>buildServer</span><span> </span><span>=</span><span> </span><span>"EpxTeamCityBuild.redmond.corp.microsoft.com"</span></p><p><span></span><span>$</span><span>buildServerQueue</span><span> </span><span>=</span><span> </span><span>"bt51"</span></p><p><span></span><span>$</span><span>doNotNeedsBits</span><span> </span><span>=</span><span> </span><span>$</span><span>false</span></p><p><span></span><span>$</span><span>addHostFileEntries</span><span> </span><span>=</span><span> </span><span>$</span><span>false</span></p><p><span></span><span>$</span><span>sqlServer</span><span> </span><span>=</span><span> </span><span>$</span><span>env</span><span>:</span><span>computername</span></p><p><span></span><span>$</span><span>appFabricServer</span><span> </span><span>=</span><span> </span><span>$</span><span>env</span><span>:</span><span>computername</span></p><p><span></span><span>$</span><span>AdminServer</span><span> </span><span>=</span><span> </span><span>$</span><span>env</span><span>:</span><span>computername</span></p><p><span></span><span>$</span><span>restartSuffix</span><span> </span><span>=</span><span> </span><span>""</span></p><p><span></span><span>$</span><span>noProxy</span><span> </span><span>=</span><span> </span><span>$</span><span>true</span></p><p><span>}</span></p><p><span>Include</span><span> </span><span>.</span><span>\</span><span>psake</span><span>\</span><span>teamcity</span><span>.</span><span>ps1</span></p><p><span>task </span><span>default</span><span> </span><span>-</span><span>depends </span><span>standalone</span></p><p><span>task </span><span>standalone</span><span> </span><span>-</span><span>depends </span><span>Setup</span><span>-</span><span>Proxy</span><span>,</span><span> </span><span>Set</span><span>-</span><span>EnvironmentParams</span><span>,</span><span> </span><span>Pull</span><span>-</span><span>Bits</span><span>,</span><span> </span><span>Setup</span><span>-</span><span>Roles</span><span>,</span><span></span></p><p><span></span><span>Disable</span><span>-</span><span>InternetExplorerESC</span><span>,</span><span> </span><span>Database</span><span>-</span><span>server</span><span>,</span><span> </span><span>Install</span><span>-</span><span>IIS</span><span>-</span><span>Rewrite</span><span>-</span><span>Module</span><span>,</span><span></span></p><p><span></span><span>Install</span><span>-</span><span>Velocity</span><span>,</span><span> </span><span>Setup</span><span>-</span><span>MSDTC</span><span>,</span><span> </span><span>Install</span><span>-</span><span>Event</span><span>-</span><span>Sources</span><span>,</span><span> </span><span>Install</span><span>-</span><span>Certificates</span><span>,</span><span></span></p><p><span></span><span>Setup</span><span>-</span><span>Response</span><span>-</span><span>Headers</span><span>,</span><span> </span><span>Register</span><span>-</span><span>ASP</span><span>,</span><span> </span><span>Wait</span><span>-</span><span>For</span><span>-</span><span>Bits</span><span>,</span><span> </span><span>Setup</span><span>-</span><span>IIS</span><span>,</span><span> </span><span>Add</span><span>-</span><span>DB</span><span>-</span><span>Perms</span><span>,</span><span></span></p><p><span></span><span>Configure</span><span>-</span><span>Velocity</span><span>,</span><span> </span><span>Install</span><span>-</span><span>WinServices</span><span>,</span><span> </span><span>Set</span><span>-</span><span>Queue</span><span>-</span><span>Perms</span></p><p><span>task </span><span>WebAppCache</span><span>-</span><span>Server</span><span> </span><span>-</span><span>depends </span><span>Setup</span><span>-</span><span>Proxy</span><span>,</span><span> </span><span>Set</span><span>-</span><span>EnvironmentParams</span><span>,</span><span> </span><span>Pull</span><span>-</span><span>Bits</span><span>,</span><span></span></p><p><span></span><span>Setup</span><span>-</span><span>Roles</span><span>,</span><span> </span><span>Configure</span><span>-</span><span>Group</span><span>-</span><span>Security</span><span>,</span><span> </span><span>Install</span><span>-</span><span>IIS</span><span>-</span><span>Rewrite</span><span>-</span><span>Module</span><span>,</span><span> </span><span>Install</span><span>-</span><span>Velocity</span><span>,</span><span></span></p><p><span></span><span>Setup</span><span>-</span><span>MSDTC</span><span>,</span><span> </span><span>Install</span><span>-</span><span>Event</span><span>-</span><span>Sources</span><span>,</span><span> </span><span>Install</span><span>-</span><span>Certificates</span><span>,</span><span> </span><span>Setup</span><span>-</span><span>Response</span><span>-</span><span>Headers</span><span>,</span><span></span></p><p><span></span><span>Register</span><span>-</span><span>ASP</span><span>,</span><span> </span><span>Wait</span><span>-</span><span>For</span><span>-</span><span>Bits</span><span>,</span><span> </span><span>Setup</span><span>-</span><span>IIS</span><span>,</span><span> </span><span>Add</span><span>-</span><span>DB</span><span>-</span><span>Perms</span><span>,</span><span> </span><span>Configure</span><span>-</span><span>Velocity</span><span>,</span><span></span></p><p><span></span><span>Install</span><span>-</span><span>WinServices</span><span>,</span><span> </span><span>Set</span><span>-</span><span>Queue</span><span>-</span><span>Perms</span></p><p><span>task </span><span>AppFabric</span><span>-</span><span>Server</span><span> </span><span>-</span><span>depends </span><span>Setup</span><span>-</span><span>Proxy</span><span>,</span><span> </span><span>Set</span><span>-</span><span>EnvironmentParams</span><span>,</span><span> </span><span>Setup</span><span>-</span><span>Roles</span><span>,</span><span></span></p><p><span></span><span>Configure</span><span>-</span><span>Group</span><span>-</span><span>Security</span><span>,</span><span> </span><span>Install</span><span>-</span><span>Velocity</span><span>,</span><span> </span><span>Configure</span><span>-</span><span>Velocity</span></p><p><span>task </span><span>Web</span><span>-</span><span>server</span><span> </span><span>-</span><span>depends </span><span>Setup</span><span>-</span><span>Proxy</span><span>,</span><span> </span><span>Set</span><span>-</span><span>EnvironmentParams</span><span>,</span><span> </span><span>Pull</span><span>-</span><span>Bits</span><span>,</span><span> </span><span>Setup</span><span>-</span><span>Roles</span><span>,</span><span></span></p><p><span></span><span>Configure</span><span>-</span><span>Group</span><span>-</span><span>Security</span><span>,</span><span> </span><span>Install</span><span>-</span><span>IIS</span><span>-</span><span>Rewrite</span><span>-</span><span>Module</span><span>,</span><span> </span><span>Setup</span><span>-</span><span>MSDTC</span><span>,</span><span> </span><span>Install</span><span>-</span><span>Event</span><span>-</span><span>Sources</span><span>,</span><span></span></p><p><span></span><span>Install</span><span>-</span><span>Certificates</span><span>,</span><span> </span><span>Setup</span><span>-</span><span>Response</span><span>-</span><span>Headers</span><span>,</span><span> </span><span>Register</span><span>-</span><span>ASP</span><span>,</span><span> </span><span>Wait</span><span>-</span><span>For</span><span>-</span><span>Bits</span><span>,</span><span></span></p><p><span></span><span>Setup</span><span>-</span><span>IIS</span><span>,</span><span> </span><span>Add</span><span>-</span><span>DB</span><span>-</span><span>Perms</span></p><p><span>task </span><span>Admin</span><span>-</span><span>Server</span><span> </span><span>-</span><span>depends </span><span>Setup</span><span>-</span><span>Proxy</span><span>,</span><span> </span><span>Set</span><span>-</span><span>EnvironmentParams</span><span>,</span><span> </span><span>Pull</span><span>-</span><span>Bits</span><span>,</span><span> </span><span>Setup</span><span>-</span><span>Roles</span><span>,</span><span></span></p><p><span></span><span>Configure</span><span>-</span><span>Group</span><span>-</span><span>Security</span><span>,</span><span> </span><span>Install</span><span>-</span><span>IIS</span><span>-</span><span>Rewrite</span><span>-</span><span>Module</span><span>,</span><span> </span><span>Setup</span><span>-</span><span>MSDTC</span><span>,</span><span> </span><span>Install</span><span>-</span><span>Event</span><span>-</span><span>Sources</span><span>,</span><span></span></p><p><span></span><span>Setup</span><span>-</span><span>Response</span><span>-</span><span>Headers</span><span>,</span><span> </span><span>Register</span><span>-</span><span>ASP</span><span>,</span><span> </span><span>Wait</span><span>-</span><span>For</span><span>-</span><span>Bits</span><span>,</span><span> </span><span>Setup</span><span>-</span><span>IIS</span><span>,</span><span> </span><span>Add</span><span>-</span><span>DB</span><span>-</span><span>Perms</span><span>,</span><span></span></p><p><span></span><span>Install</span><span>-</span><span>WinServices</span><span>,</span><span> </span><span>Set</span><span>-</span><span>Queue</span><span>-</span><span>Perms</span></p><p><span>task </span><span>Database</span><span>-</span><span>Server</span><span> </span><span>-</span><span>depends </span><span>Set</span><span>-</span><span>EnvironmentParams</span><span>,</span><span> </span><span>Configure</span><span>-</span><span>Group</span><span>-</span><span>Security</span><span>,</span><span></span></p><p><span></span><span>Install</span><span>-</span><span>SqlServer</span><span>,</span><span> </span><span>Create</span><span>-</span><span>Databases</span></p><p><span>task </span><span>Post</span><span>-</span><span>Restart</span><span>-</span><span>Full</span><span> </span><span>-</span><span>depends </span><span>Set</span><span>-</span><span>EnvironmentParams</span><span>,</span><span> </span><span>Remove</span><span>-</span><span>Startup</span><span>,</span><span></span></p><p><span></span><span>Configure</span><span>-</span><span>Velocity</span><span>,</span><span> </span><span>Install</span><span>-</span><span>WinServices</span><span>,</span><span> </span><span>Set</span><span>-</span><span>Queue</span><span>-</span><span>Perms</span></p><p><span>task </span><span>Post</span><span>-</span><span>Restart</span><span> </span><span>-</span><span>depends </span><span>Remove</span><span>-</span><span>Startup</span><span>,</span><span> </span><span>Configure</span><span>-</span><span>Velocity</span></p><p><span>task </span><span>Get</span><span>-</span><span>Bits</span><span> </span><span>-</span><span>depends </span><span>Set</span><span>-</span><span>EnvironmentParams</span><span>,</span><span> </span><span>Pull</span><span>-</span><span>Bits</span><span>,</span><span> </span><span>Wait</span><span>-</span><span>For</span><span>-</span><span>Bits</span></p></div></td></tr></tbody></table>

 By looking at the tasks, you can get a feel for all that’s involved at each tier. First let me say that this script took about 20x more effort to write than the deployment script. I’m proud to report that I mastered file-copying long ago. Once I finally managed to figure out the difference between source and destination, it’s been smooth sailing ever since. This script really taught me a lot about not only PowerShell but also a lot about how the windows OS and many of the administrative apps work together.

If I had to identify the step that was the biggest pain in the butt to figure out, by far and away it was installing and configuring [AppFabric](http://msdn.microsoft.com/en-us/windowsserver/ee695849). This is Microsoft’s distributed caching solution formerly known as Velocity. One thing that makes it tricky is that, at least in my case, it requires a reboot after installation and before configuration. I certainly do not want to include our entire server setup script here but let me include the AppFabric portion. Again keep in mind this is coming from a psake-consumable script. So the tasks can be thought of as the “entry points” of the script while the functions serve as “private” helper methods to those from more formal programming languages.

<table><tbody><tr><td data-settings="hide"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p></div></td><td><div><p><span>task</span><span> </span><span>Install</span><span>-</span><span>Velocity</span><span> </span><span>-</span><span>depends</span><span> </span><span>Install</span><span>-</span><span>DotNet4</span><span> </span><span>{</span></p><p><span></span><span>$</span><span>global</span><span>:</span><span>restartNeeded</span><span> </span><span>=</span><span> </span><span>$</span><span>false</span></p><p><span></span><span>Start</span><span>-</span><span>Service</span><span> </span><span>-</span><span>displayname</span><span> </span><span>"Windows Update"</span></p><p><span></span><span>if</span><span> </span><span>(</span><span>!</span><span>(</span><span>Test</span><span>-</span><span>Path</span><span> </span><span>"$env:windir\system32\AppFabric"</span><span>)</span><span>)</span><span>{</span>&nbsp;<span></span></p><p><span></span><span>$</span><span>dest</span><span> </span><span>=</span><span> </span><span>"appfabric.exe"</span>&nbsp;<span></span></p><p><span></span><span>if</span><span> </span><span>(</span><span>Is64Bit</span><span>)</span><span>{</span>&nbsp;<span></span></p><p><span></span><span>$</span><span>url</span><span> </span><span>=</span><span> </span><span>"HTTP://download.microsoft.com/download/1/A/D/</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1ADC8F3E-4446-4D31-9B2B-9B4578934A22/WindowsServerAppFabricSetup_x64_6.1.exe"</span>&nbsp;<span></span></p><p><span></span><span>}</span><span> </span><span>else</span><span>{</span>&nbsp;<span></span></p><p><span></span><span>$</span><span>url</span><span> </span><span>=</span><span> </span><span>"HTTP://download.microsoft.com/download/1/A/D/</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1ADC8F3E-4446-4D31-9B2B-9B4578934A22/WindowsServerAppFabricSetup_x86_6.1.exe"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span></span></p><p><span></span><span>}</span>&nbsp;<span></span></p><p><span></span><span>Download</span><span>-</span><span>File</span><span> </span><span>$</span><span>url</span><span> </span><span>(</span><span>join</span><span>-</span><span>path</span><span> </span><span>$</span><span>currentDir</span><span> </span><span>$</span><span>dest</span><span>)</span></p><p><span></span><span>.</span><span>/</span><span>appfabric</span><span>.</span><span>exe</span><span> </span><span>/</span><span>i</span><span> </span><span>"cachingservice,cacheclient,cacheadmin"</span></p><p><span></span><span>Start</span><span>-</span><span>Sleep</span><span> </span><span>-</span><span>s</span><span> </span><span>10</span></p><p><span></span><span>$</span><span>p</span><span> </span><span>=</span><span> </span><span>Get</span><span>-</span><span>Process</span><span> </span><span>"appfabric"</span></p><p><span></span><span>$</span><span>p</span><span>.</span><span>WaitForExit</span><span>(</span><span>)</span></p><p><span></span><span>$</span><span>global</span><span>:</span><span>restartNeeded</span><span> </span><span>=</span><span> </span><span>$</span><span>true</span></p><p><span></span><span>}</span><span> </span><span>else</span>&nbsp;<span></span></p><p><span></span><span>{</span>&nbsp;<span></span></p><p><span></span><span>Write</span><span>-</span><span>Host</span><span> </span><span>"AppFabric - Already Installed..."</span><span> </span><span>-</span><span>ForegroundColor </span><span>Green</span><span></span></p><p><span></span><span>}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span></span></p><p><span>}</span></p><p><span>task </span><span>Configure</span><span>-</span><span>Velocity</span><span> </span><span>-</span><span>depends </span><span>Create</span><span>-</span><span>Velocity</span><span>-</span><span>Share</span><span>,</span><span> </span><span>Install</span><span>-</span><span>Velocity</span><span> </span><span>{</span></p><p><span></span><span>if</span><span>(</span><span>$</span><span>global</span><span>:</span><span>restartNeeded</span><span> </span><span>-</span><span>eq</span><span> </span><span>$</span><span>true</span><span> </span><span>-</span><span>or</span><span> </span><span>$</span><span>global</span><span>:</span><span>restartNeededOverride</span><span> </span><span>-</span><span>eq</span><span> </span><span>$</span><span>true</span><span>)</span><span> </span><span>{</span><span></span></p><p><span></span><span>RebootAndContinue</span><span></span></p><p><span></span><span>}</span></p><p><span></span><span>Load</span><span>-</span><span>Module </span><span>DistributedCacheConfiguration</span></p><p><span></span><span>$</span><span>clusterInfo</span><span> </span><span>=</span><span> </span><span>Get</span><span>-</span><span>CacheClusterInfo</span><span> </span><span>"XML"</span><span> </span><span>"\\$env:computername\$appFabricShareName"</span></p><p><span></span><span>if</span><span>(</span><span> </span><span>$</span><span>clusterInfo</span><span>.</span><span>IsInitialized</span><span> </span><span>-</span><span>eq</span><span> </span><span>$</span><span>false</span><span> </span><span>)</span><span> </span><span>{</span></p><p><span></span><span>new</span><span>-</span><span>CacheCluster</span><span> </span><span>"XML"</span><span> </span><span>"\\$env:computername\$appFabricShareName"</span><span> </span><span>"Medium"</span></p><p><span></span><span>Register</span><span>-</span><span>CacheHost</span><span> </span><span>-</span><span>Provider </span><span>XML</span><span> </span><span>-</span><span>ConnectionString</span><span> </span><span>"\\$env:computername\$appFabricShareName"</span>&nbsp;<span></span></p><p><span></span><span>-</span><span>CachePort</span><span> </span><span>22233</span><span> </span><span>-</span><span>ClusterPort</span><span> </span><span>22234</span>&nbsp;<span> </span><span>-</span><span>ArbitrationPort</span><span> </span><span>22235</span><span> </span><span>-</span><span>ReplicationPort</span><span> </span><span>22236</span><span></span></p><p><span></span><span>-</span><span>HostName</span><span> </span><span>$</span><span>env</span><span>:</span><span>computername</span><span> </span><span>-</span><span>Account</span><span> </span><span>"NT AUTHORITY\Network Service"</span></p><p><span></span><span>Add</span><span>-</span><span>CacheHost</span><span> </span><span>-</span><span>Provider </span><span>XML</span><span> </span><span>-</span><span>ConnectionString</span><span> </span><span>"\\$env:computername\$appFabricShareName"</span><span></span></p><p><span></span><span>-</span><span>Account</span><span> </span><span>"NT AUTHORITY\Network Service"</span></p><p><span></span><span>Load</span><span>-</span><span>Module </span><span>DistributedCacheAdministration</span></p><p><span></span><span>use</span><span>-</span><span>cachecluster</span><span> </span><span>-</span><span>Provider </span><span>XML</span><span> </span><span>-</span><span>ConnectionString</span><span> </span><span>"\\$env:computername\$appFabricShareName"</span></p><p><span></span><span>New</span><span>-</span><span>Cache </span><span>ForumsCache</span><span> </span><span>-</span><span>TimeToLive</span><span> </span><span>1440</span></p><p><span></span><span>Set</span><span>-</span><span>CacheClusterSecurity</span><span> </span><span>-</span><span>SecurityMode </span><span>None</span><span> </span><span>-</span><span>ProtectionLevel </span><span>None</span></p><p><span></span><span>start</span><span>-</span><span>cachecluster</span></p><p><span></span><span>netsh </span><span>firewall </span><span>set</span><span> </span><span>allowedprogram</span><span></span></p><p><span></span><span>$</span><span>env</span><span>:</span><span>systemroot</span><span>\</span><span>system32</span><span>\</span><span>AppFabric</span><span>\</span><span>DistributedCacheService</span><span>.</span><span>exe </span><span>APPFABRIC </span><span>enable</span></p><p><span></span><span>}</span></p><p><span>}</span></p><p><span>function</span><span> </span><span>Is64Bit</span>&nbsp;<span></span></p><p><span>{</span>&nbsp;<span></span></p><p><span></span><span>[</span><span>IntPtr</span><span>]</span><span>::</span><span>Size</span><span> </span><span>-</span><span>eq</span><span> </span><span>8</span>&nbsp;<span></span></p><p><span>}</span></p><p><span>function </span><span>Download</span><span>-</span><span>File</span><span>(</span><span>[</span><span>string</span><span>]</span><span> </span><span>$</span><span>url</span><span>,</span><span> </span><span>[</span><span>string</span><span>]</span><span> </span><span>$</span><span>path</span><span>)</span><span> </span><span>{</span></p><p><span></span><span>Write</span><span>-</span><span>Host</span><span> </span><span>"Downloading $url to $path"</span></p><p><span></span><span>$</span><span>downloader</span><span> </span><span>=</span><span> </span><span>new</span><span>-</span><span>object</span><span> </span><span>System</span><span>.</span><span>Net</span><span>.</span><span>WebClient</span></p><p><span></span><span>$</span><span>downloader</span><span>.</span><span>DownloadFile</span><span>(</span><span>$</span><span>url</span><span>,</span><span> </span><span>$</span><span>path</span><span>)</span><span></span></p><p><span>}</span></p><p><span>function</span><span> </span><span>RebootAndContinue</span><span> </span><span>{</span></p><p><span></span><span>$</span><span>global</span><span>:</span><span>restartNeededOverride</span><span> </span><span>=</span><span> </span><span>$</span><span>false</span></p><p><span></span><span>Copy</span><span>-</span><span>Item</span><span> </span><span>"$currentDir\post-restart-$restartSuffix.bat"</span><span></span></p><p><span></span><span>"$env:appdata\Microsoft\Windows\Start Menu\programs\startup"</span></p><p><span></span><span>Restart</span><span>-</span><span>Computer</span><span> </span><span>-</span><span>Force</span></p><p><span>}</span></p></div></td></tr></tbody></table>

Now there are several ways to configure AppFabric and this just demonstrates one approach. This uses the XML provider and it only installs the caching features of AppFabric.

## **Installing applications with Chocolatey**

One “rediscovery” I made throughout this process is an open source project built on top of Nuget called [Chocolatey](http://chocolatey.org/). This is the brain child of [Rob Reynolds](http://ferventcoder.com/) who is one of the original creators of what we know of as [Nuget](http://nuget.org/) today and was once called Nu before development was handed off to Microsoft and [Outercurve](http://www.outercurve.org/). I say “rediscovery” because I stumbled upon this a year ago but didn’t really get it. However it really makes sense when it comes to build/setup automation whether that is an application server or your personal machine.

Chocolatey is a framework around the processes of installing and setting up applications via silent installations. Many of the apps that you and I are accustomed to manually download then launch the installer and click next, next, next, finish, are available via [Chocolatey’s public feed](http://chocolatey.org/). In addition to its own feed, it exposes the [web platform installer’s](http://www.microsoft.com/web/downloads/platform.aspx) command line utility so that any application available via the web platform installer can be silently installed with Chocolatey. Since it really just sits on top of Nuget, you can provide your own private feed as well.

So lets look at exactly how this works by exploring my setup script’s bootstrapper:

<table><tbody><tr><td data-settings="hide"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p></div></td><td><div><p><span>param</span><span>(</span></p><p><span></span><span>[</span><span>string</span><span>]</span><span>$</span><span>task</span><span>=</span><span>"standalone"</span><span>,</span></p><p><span></span><span>[</span><span>string</span><span>]</span><span>$</span><span>environment</span><span>=</span><span>"test"</span><span>,</span></p><p><span></span><span>[</span><span>string</span><span>]</span><span>$</span><span>sqlServer</span><span> </span><span>=</span><span> </span><span>$</span><span>env</span><span>:</span><span>computername</span><span>,</span></p><p><span></span><span>[</span><span>string</span><span>]</span><span>$</span><span>appFabricServer</span><span> </span><span>=</span><span> </span><span>$</span><span>env</span><span>:</span><span>computername</span><span>,</span></p><p><span></span><span>[</span><span>string</span><span>]</span><span>$</span><span>AdminServer</span><span> </span><span>=</span><span> </span><span>$</span><span>env</span><span>:</span><span>computername</span><span>,</span></p><p><span></span><span>[</span><span>string</span><span>]</span><span>$</span><span>domain</span><span> </span><span>=</span><span> </span><span>"redmond.corp.microsoft.com"</span><span>,</span></p><p><span></span><span>[</span><span>switch</span><span>]</span><span>$</span><span>doNotNeedBits</span><span>,</span></p><p><span></span><span>[</span><span>switch</span><span>]</span><span>$</span><span>addHostFileEntries</span><span>,</span></p><p><span></span><span>[</span><span>switch</span><span>]</span><span>$</span><span>skipPrerequisites</span><span>,</span></p><p><span></span><span>[</span><span>switch</span><span>]</span><span>$</span><span>noProxy</span></p><p><span>)</span></p><p><span>iex</span><span> </span><span>(</span><span>(</span><span>new</span><span>-</span><span>object</span><span> </span><span>net</span><span>.</span><span>webclient</span><span>)</span><span>.</span><span>DownloadString</span><span>(</span><span>'HTTP://bit.ly/psChocInstall'</span><span>)</span><span>)</span></p><p><span>if</span><span>(</span><span>-</span><span>not</span><span> </span><span>$</span><span>skipPrerequisites</span><span>)</span><span> </span><span>{</span></p><p><span></span><span>.</span><span>$</span><span>env</span><span>:</span><span>systemdrive</span><span>\</span><span>chocolatey</span><span>\</span><span>chocolateyinstall</span><span>\</span><span>chocolatey</span><span>.</span><span>cmd </span><span>install </span><span>hg</span></p><p><span></span><span>if</span><span>(</span><span> </span><span>test</span><span>-</span><span>path</span><span> </span><span>"$env:programfiles\Mercurial"</span><span> </span><span>)</span><span> </span><span>{</span></p><p><span></span><span>$</span><span>mPath</span><span>=</span><span>"$env:programfiles\Mercurial"</span></p><p><span></span><span>}</span><span></span></p><p><span></span><span>else</span><span> </span><span>{</span><span></span></p><p><span></span><span>$</span><span>mPath</span><span> </span><span>=</span><span> </span><span>"${env:programfiles(x86)}\Mercurial"</span><span></span></p><p><span></span><span>}</span></p><p><span></span><span>if</span><span>(</span><span> </span><span>-</span><span>not</span><span>(</span><span> </span><span>test</span><span>-</span><span>path</span><span> </span><span>$</span><span>env</span><span>:</span><span>systemdrive</span><span>\</span><span>dev</span><span> </span><span>)</span><span>)</span><span> </span><span>{</span><span> </span><span>mkdir</span><span> </span><span>$</span><span>env</span><span>:</span><span>systemdrive</span><span>\</span><span>dev</span><span> </span><span>}</span></p><p><span></span><span>set</span><span>-</span><span>location</span><span> </span><span>$</span><span>env</span><span>:</span><span>systemdrive</span><span>\</span><span>dev</span></p><p><span></span><span>if</span><span>(</span><span> </span><span>test</span><span>-</span><span>path </span><span>socialbuilds</span><span> </span><span>)</span><span> </span><span>{</span></p><p><span></span><span>set</span><span>-</span><span>location </span><span>socialbuilds</span></p><p><span></span><span>.</span><span>$</span><span>mPath</span><span>\</span><span>hg </span><span>pull</span></p><p><span></span><span>.</span><span>$</span><span>mPath</span><span>\</span><span>hg </span><span>update</span></p><p><span></span><span>}</span></p><p><span></span><span>else</span><span> </span><span>{</span></p><p><span></span><span>.</span><span>$</span><span>mPath</span><span>\</span><span>hg </span><span>clone </span><span>HTTPs</span><span>:</span><span>//epxsource/SocialBuilds</span></p><p><span></span><span>set</span><span>-</span><span>location </span><span>socialbuilds</span></p><p><span></span><span>}</span></p><p><span>}</span></p><p><span>if</span><span>(</span><span>$</span><span>task</span><span> </span><span>-</span><span>eq</span><span> </span><span>"standalone"</span><span>)</span><span> </span><span>{</span><span>$</span><span>addHostFileEntries</span><span>=</span><span>$</span><span>true</span><span>}</span></p><p><span>if</span><span>(</span><span>$</span><span>task</span><span> </span><span>-</span><span>ne</span><span> </span><span>"AppFabric-Server"</span><span>)</span><span> </span><span>{</span><span>$</span><span>restartSuffix</span><span>=</span><span>"Full"</span><span>}</span></p><p><span>.</span><span>/</span><span>psake</span><span>/</span><span>psake</span><span>.</span><span>ps1 </span><span>cleansetup</span><span>.</span><span>ps1</span><span> </span><span>-</span><span>tasklist</span><span> </span><span>$</span><span>task</span><span> </span><span>-</span><span>properties</span><span> </span><span>@</span><span>{</span><span>env</span><span>=</span><span>$</span><span>environment</span><span>;</span><span>sqlServer</span><span>=</span><span>$</span><span>sqlServer</span><span>;</span></p><p><span></span><span>appFabricServer</span><span>=</span><span>$</span><span>appFabricServer</span><span>;</span><span>AdminServer</span><span>=</span><span>$</span><span>AdminServer</span><span>;</span><span>domain</span><span>=</span><span>$</span><span>domain</span><span>;</span></p><p><span></span><span>doNotNeedBits</span><span>=</span><span>$</span><span>doNotNeedBits</span><span>;</span><span>addHostFileEntries</span><span>=</span><span>$</span><span>addHostFileEntries</span><span>;</span></p><p><span></span><span>restartSuffix</span><span>=</span><span>$</span><span>restartSuffix</span><span>;</span><span>noProxy</span><span>=</span><span>$</span><span>noProxy</span><span>}</span></p></div></td></tr></tbody></table>

 Notice these key lines:

<table><tbody><tr><td data-settings="hide"></td><td><div><p><span>iex</span><span> </span><span>(</span><span>(</span><span>new</span><span>-</span><span>object</span><span> </span><span>net</span><span>.</span><span>webclient</span><span>)</span><span>.</span><span>DownloadString</span><span>(</span><span>'HTTP://bit.ly/psChocInstall'</span><span>)</span><span>)</span></p></div></td></tr></tbody></table>

This Downloads and installs Chocolatey and then here is an example of using chocolatey to download the Mercurial source control client:

<table><tbody><tr><td data-settings="hide"></td><td><div><p><span>.</span><span>$</span><span>env</span><span>:</span><span>systemdrive</span><span>\</span><span>chocolatey</span><span>\</span><span>chocolateyinstall</span><span>\</span><span>chocolatey</span><span>.</span><span>cmd </span><span>install </span><span>hg</span></p></div></td></tr></tbody></table>

 I should point out that under most circumstances, the above line could simply be:

 Chocolatey’s install puts itself in your path, and creates some aliases that makes this possible; but because I use Chocolatey here in the same script that installs Chocolatey, the environment variables it sets are not available to me yet. I’d need to open a new shell.

As a side note, I use chocolatey all the time now. If I need to hop on a random box and install a tool or set of tools, I now just launch a few lines of PowerShell and its all there. At Microsoft I often get asked for source code to my repos by fellow employees who are unfamiliar with Mercurial. I have found that sending an email like this is very effective:

“Hi Phil,

You can get that from HTTPs://epxsource/Galleries. We use Mercurial. The easiest way to get everything you need is to launch this from PowerShell as admin:

<table><tbody><tr><td data-settings="hide"></td><td><div><p><span>iex </span><span>(</span><span>(</span><span>new</span><span>-</span><span>object</span><span> </span><span>net</span><span>.</span><span>webclient</span><span>)</span><span>.</span><span>DownloadString</span><span>(</span><span>'HTTP://bit.ly/psChocInstall'</span><span>)</span><span>)</span><span></span></p><p><span>.</span><span>$</span><span>env</span><span>:</span><span>systemdrive</span><span>\</span><span>chocolatey</span><span>\</span><span>chocolateyinstall</span><span>\</span><span>chocolatey</span><span>.</span><span>cmd</span><span> </span><span>install</span><span> </span><span>hg</span><span></span></p><p><span>$</span><span>env</span><span>:</span><span>programfiles</span><span>\</span><span>Mercurial</span><span>\</span><span>hg</span><span> </span><span>clone</span><span> </span><span>HTTPs</span><span>:</span><span>/</span><span>/</span><span>epxsource</span><span>/</span><span>Galleries</span></p></div></td></tr></tbody></table>

This will install Mercurial and clone the galleries repo.

Matt”

How cool is that? No Mercurial tutorial needed and sometimes I get a reply back telling me what a cool script that is. I should really forward the compliment to Rob Reynolds since he was the one who, basically, wrote it.

So this really makes the consumption of my server setup script simple. As you can see, it basically clones (or updates) my script repo on the target machine where the script runs. This also means that, if I commit changes to my script, rerunning this script on the box will automatiucally pull in those changes. To simplify things further, I provide a batch file wrapper so that the script can be launched from any command line:

<table><tbody><tr><td data-settings="hide"></td><td><div><p><span>@</span><span>echo </span><span>off</span></p><p><span>PowerShell</span><span> </span><span>-</span><span>NonInteractive</span><span> </span><span>-</span><span>NoProfile</span><span> </span><span>-</span><span>ExecutionPolicy </span><span>bypass</span><span></span></p><p><span></span><span>-</span><span>Command</span><span> </span><span>"&amp; '%~dp0bootstrap\bootstrap.ps1' %*"</span></p></div></td></tr></tbody></table>

The only thing this does is to call the PowerShell bootstrap.ps1 script (the one listed before) but key to this call is:

 Without this and assuming this script is being run on a fresh box, the user would get an error trying to run most PowerShell scripts. This prevents any scripts from blocking and suppresses all warnings regarding the security of the scripts. Often you will see advice that suggests that you use “unrestricted”. However, I have found that “bypass” is better especially since I have had issues with setting the execution policy to ‘unrestricted’ on Windows 8. According to [the documentation](http://technet.microsoft.com/en-us/library/dd347641.aspx) on execution policies:

**Bypass**  
_– Nothing is blocked and there are no warnings or prompts._

_– This execution policy is designed for configurations in which a Windows PowerShell script is built in to a a larger application or for configurations in which Windows PowerShell is the foundation for a program that has its own security model._

This seems to match the use case here.

### **The one liner setup call**

So now, as long as I put my batch file and bootstrap.ps1 on a network share accessible to others who need to use it, simply typing this at any command prompt will kick off the script:

<table><tbody><tr><td data-settings="hide"></td><td><div><p><span>\</span><span>\</span><span>server</span><span>\</span><span>share</span><span>\</span><span>bootstrap</span><span>.</span><span>bat</span></p></div></td></tr></tbody></table>

 By default, with no command line parameters passed in, a standalone setup will be installed. In my case, it takes about an hour to complete and I have a fully-functioning set of applications when finished.

## **Making this personal**

I’ve been very impressed with what I can get done in PowerShell, and by the ease with which I can install many applications using Chocolatey. This has inspired me to create a personal bootstrapper which I have been tweaking over the past several weeks. It is still very rough and there is much I want to add but I’d like to craft it into a sort of framework allowing individuals to create sort of “recipes” that will serve up an environment to their liking. We are all VERY particular about how our environments are laid out and there really is no ‘one size fits all’.

If you are interested in seeing where I am going with this, I have been keeping it at Codeplex [here](http://autobox.codeplex.com/). Right now this is really about setting up MY box, but it does do some interesting things such as to download and install windows updates, turn off UAC (that dialog box that you may have never clicked “no” on) and makes Windows Explorer usable by changing the defaults and showing me hidden files and known extensions. Here is the script for the windows explorer “fix”:

<table><tbody><tr><td data-settings="hide"></td><td><div><p><span>function </span><span>Configure</span><span>-</span><span>ExplorerOptions</span><span>(</span><span>[</span><span>switch</span><span>]</span><span>$</span><span>showHidenFilesFoldersDrives</span><span>,</span><span></span></p><p><span></span><span>[</span><span>switch</span><span>]</span><span>$</span><span>showProtectedOSFiles</span><span>,</span><span></span></p><p><span></span><span>[</span><span>switch</span><span>]</span><span>$</span><span>showFileExtensions</span><span>)</span><span> </span><span>{</span></p><p><span></span><span>$</span><span>key</span><span> </span><span>=</span><span> </span><span>'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced'</span></p><p><span></span><span>if</span><span>(</span><span>$</span><span>showHidenFilesFoldersDrives</span><span>)</span><span> </span><span>{</span><span>Set</span><span>-</span><span>ItemProperty</span><span> </span><span>$</span><span>key </span><span>Hidden</span><span> </span><span>1</span><span>}</span></p><p><span></span><span>if</span><span>(</span><span>$</span><span>showFileExtensions</span><span>)</span><span> </span><span>{</span><span>Set</span><span>-</span><span>ItemProperty</span><span> </span><span>$</span><span>key </span><span>HideFileExt</span><span> </span><span>0</span><span>}</span></p><p><span></span><span>if</span><span>(</span><span>$</span><span>showProtectedOSFiles</span><span>)</span><span> </span><span>{</span><span>Set</span><span>-</span><span>ItemProperty</span><span> </span><span>$</span><span>key </span><span>ShowSuperHidden</span><span> </span><span>1</span><span>}</span></p><p><span></span><span>Stop</span><span>-</span><span>Process</span><span> </span><span>-</span><span>processname </span><span>explorer</span><span> </span><span>-</span><span>Force</span></p><p><span>}</span></p></div></td></tr></tbody></table>

  So I hope you have found this helpful.
