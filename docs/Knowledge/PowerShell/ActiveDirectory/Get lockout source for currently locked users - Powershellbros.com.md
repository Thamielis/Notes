![lockout source](Get%20lockout%20source%20for%20currently%20locked%20users%20-%20Powershellbros.com/lockout-source.png)

Todays articile is about getting lockout source and checking who is currently locked in your environment. Script is based on **ActiveDirectory** module and **Get-WinEvent** commands.

##### Currently locked users

First we need to check how many users are locked. Below you can find simple script for checking that. Script is using `Search-ADAccount` command with **LockedOut** parameter.

<table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p></td><td><div><p><code>$LockedUsers</code> <code>= @()</code></p><p><code>Search-ADAccount</code> <code>-LockedOut</code> <code>| select</code> <code>-first</code> <code>10 | </code><code>foreach</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$City</code> <code>= </code><code>$Object</code> <code>= </code><code>$Null</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$City</code> <code>= (</code><code>Get-ADUser</code> <code>-Identity</code> <code>$_</code><code>.name</code> <code>-Properties</code> <code>City).City</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code> <code>= </code><code>New-Object</code> <code>PSObject</code> <code>-Property</code> <code>(</code><code>[ordered]</code><code>@{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = </code><code>$_</code><code>.name</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Locked&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = </code><code>$_</code><code>.lockedout</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Location&nbsp;&nbsp;&nbsp;&nbsp; = </code><code>$City</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>UPN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = </code><code>$_</code><code>.UserPrincipalName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>})</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$LockedUsers</code> <code>+= </code><code>$Object</code></p><p><code>}</code></p><p><code>"Currently locked users:"</code></p><p><code>$LockedUsers</code> <code>| </code><code>Format-Table</code> <code>-AutoSize</code> <code>-Wrap</code></p></div></td></tr></tbody></table>

[![locked users](Get%20lockout%20source%20for%20currently%20locked%20users%20-%20Powershellbros.com/locked-users-1024x246.png)](https://i1.wp.com/www.powershellbros.com/wp-content/uploads/2018/09/locked-users.png)

locked users

##### Find lockout source

Next part is to find lockout source for each users. To do this we need check PDC server name and get events (id 4740) from its security log. In this particluar example I used **users.txt** file:

<table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p></td><td><div><p><code>$SourceEvents</code> <code>= @()</code></p><p><code>$PDCServer</code> <code>= (</code><code>Get-AdDomain</code><code>).PDCEmulator</code></p><p><code>$Users</code> <code>=&nbsp; </code><code>Get-Content</code> <code>"c:\users\$env:username\desktop\users.txt"</code></p><p><code>Try{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$SourceEvents</code> <code>= </code><code>Foreach</code> <code>(</code><code>$User</code> <code>in</code> <code>$Users</code><code>){</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>icm</code> <code>-cn</code> <code>$PDCServer</code> <code>{</code><code>param</code><code>(</code><code>$User</code><code>)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code> <code>= @{}| select Username,TimeCreated,Source</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code><code>.Username = </code><code>$User</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Events</code> <code>= </code><code>Get-WinEvent</code> <code>-FilterHashtable</code> <code>@{LogName=</code><code>"Security"</code><code>;ID=</code><code>"4740"</code><code>} | Where {</code><code>$_</code><code>.message </code><code>-match</code> <code>$User</code><code>} | select</code> <code>-first</code> <code>1</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>If</code><code>(</code><code>$Events</code><code>){</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code><code>.Source = </code><code>$Events</code><code>.properties.value[1]</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code><code>.timecreated = </code><code>$Events</code><code>.timecreated</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Else</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code><code>.Source = </code><code>" - "</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code><code>.timecreated = </code><code>" - "</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code> <code>-ArgumentList</code> <code>$User</code> <code>-ErrorAction</code> <code>stop | select @{n=</code><code>'ServerName'</code><code>;e={</code><code>$_</code><code>.pscomputername}},Username,TimeCreated,Source</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p><p><code>Catch </code><code>[System.Exception]</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Write-host</code> <code>"Error"</code> <code>-backgroundcolor</code> <code>red</code> <code>-foregroundcolor</code> <code>yellow</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$_</code><code>.Exception.Message</code></p><p><code>}</code></p><p><code>"Checking lockout source on $PDCServer :"</code></p><p><code>$SourceEvents</code> <code>| </code><code>Format-Table</code> <code>-AutoSize</code> <code>-Wrap</code></p></div></td></tr></tbody></table>

[![source](Get%20lockout%20source%20for%20currently%20locked%20users%20-%20Powershellbros.com/source.png)](https://i1.wp.com/www.powershellbros.com/wp-content/uploads/2018/09/source.png)

source

I wanted to check all of this in single script. After combining both codes you gonna get report for currently locked users and source information.

**Final script:**

<table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p></td><td><div><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$LockedUsers</code> <code>= @()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$SourceEvents</code> <code>= @()</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$PDCServer</code> <code>= (</code><code>Get-AdDomain</code><code>).PDCEmulator</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Search-ADAccount</code> <code>-LockedOut</code> <code>| select</code> <code>-first</code> <code>10 | </code><code>foreach</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$City</code> <code>= </code><code>$Object</code> <code>= </code><code>$Null</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$City</code> <code>= (</code><code>Get-ADUser</code> <code>-Identity</code> <code>$_</code><code>.name</code> <code>-Properties</code> <code>City).City</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code> <code>= </code><code>New-Object</code> <code>PSObject</code> <code>-Property</code> <code>(</code><code>[ordered]</code><code>@{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = </code><code>$_</code><code>.name</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Locked&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = </code><code>$_</code><code>.lockedout</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Location&nbsp;&nbsp;&nbsp;&nbsp; = </code><code>$City</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>UPN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = </code><code>$_</code><code>.UserPrincipalName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>})</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$LockedUsers</code> <code>+= </code><code>$Object</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"Currently locked users:"</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$LockedUsers</code> <code>| </code><code>Format-Table</code> <code>-AutoSize</code> <code>-Wrap</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Users</code> <code>=&nbsp; </code><code>$LockedUsers</code><code>.Name</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Try{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$SourceEvents</code> <code>= </code><code>Foreach</code> <code>(</code><code>$User</code> <code>in</code> <code>$Users</code><code>){</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>icm</code> <code>-cn</code> <code>$PDCServer</code> <code>{</code><code>param</code><code>(</code><code>$User</code><code>)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code> <code>= @{}| select Username,TimeCreated,Source</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code><code>.Username = </code><code>$User</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Events</code> <code>= </code><code>Get-WinEvent</code> <code>-FilterHashtable</code> <code>@{LogName=</code><code>"Security"</code><code>;ID=</code><code>"4740"</code><code>} | Where {</code><code>$_</code><code>.message </code><code>-match</code> <code>$User</code><code>} | select</code> <code>-first</code> <code>1</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>If</code><code>(</code><code>$Events</code><code>){</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code><code>.Source = </code><code>$Events</code><code>.properties.value[1]</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code><code>.timecreated = </code><code>$Events</code><code>.timecreated</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Else</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code><code>.Source = </code><code>" - "</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code><code>.timecreated = </code><code>" - "</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Object</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code> <code>-ArgumentList</code> <code>$User</code> <code>-ErrorAction</code> <code>stop | select @{n=</code><code>'ServerName'</code><code>;e={</code><code>$_</code><code>.pscomputername}},Username,TimeCreated,Source</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Catch </code><code>[System.Exception]</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Write-host</code> <code>"Error"</code> <code>-backgroundcolor</code> <code>red</code> <code>-foregroundcolor</code> <code>yellow</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$_</code><code>.Exception.Message</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"Lockout source found in $PDCServer :"</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$SourceEvents</code> <code>| </code><code>Format-Table</code> <code>-AutoSize</code> <code>-Wrap</code></p></div></td></tr></tbody></table>

I hope this was informative for you 🙂 See you in next articiles.  
[How to create html report for AD Users?](http://www.powershellbros.com/create-your-own-html-report-email/)