Todayâ€™s script will help you to in easy way find duplicated SPNs in Active Directory.

What is SPN?

[SPN (Service Principal Name)](https://msdn.microsoft.com/en-us/library/ms677949(v=vs.85).aspx) according to Microsoft definition is unique identifier of service instance. To better understand it we can compare it to alias ([CNAME](http://www.powershellbros.com/updating-dns-alias-powershell/) record) in DNS.  
A Service Principal Name is a pointer to account created in Active Directory domain. It can be either created for service account or computer object account.  
E.g.  
**HTTP/TestWebSite** is an alias for the account **Contoso.com\\TestWebSiteAccount**.

Below screenshot from Active Directory attribute of Service Principal.  
[![](Find%20duplicated%20SPNs%20in%20Active%20Directory%20-%20Powershellbros.com/SPN.png)](https://i1.wp.com/www.powershellbros.com/wp-content/uploads/2018/01/SPN.png)

##### How script works?

Script is gathering all users and computers account from Active Directory where Service Principal Name attribute is not empty.  
In next section it is analyzing all service principal names and looks for duplicated.  
If the script will find Service Principal Names with different SamAccountNames it will notify user that duplicated SPN has been found.

##### Script:

<table><tbody><tr><td><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p></td><td><div><p><code>$AllSPNsObjects</code> <code>= </code><code>Get-ADObject</code> <code>-Filter</code> <code>"(objectClass -eq 'user') -and (objectClass -eq 'computer')"</code> <code>-Properties</code> <code>sAMAccountName, servicePrincipalName | </code><code>Where-Object</code> <code>servicePrincipalName </code><code>-ne</code> <code>$null</code></p><p><code>$SPNArray</code> <code>= @()</code></p><p><code>foreach</code> <code>(</code><code>$SPNObject</code> <code>in</code> <code>$AllSPNsObjects</code><code>)</code></p><p><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;</code><code>$SamAccountName</code> <code>= </code><code>$SPNObject</code><code>.SamAccountName</code></p><p><code>&nbsp;&nbsp;&nbsp;</code><code>$ServicePrincipalNames</code> <code>= </code><code>$SPNObject</code><code>.ServicePrincipalName</code></p><p><code>&nbsp;&nbsp;&nbsp;</code><code>foreach</code> <code>(</code><code>$ServicePrincipalName</code> <code>in</code> <code>$ServicePrincipalNames</code><code>)</code></p><p><code>&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(</code><code>$SPNArray</code><code>.ServicePrincipalName </code><code>-like</code> <code>"$ServicePrincipalName"</code><code>)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$MatchedSPNs</code> <code>= </code><code>$SPNArray</code><code>.ServicePrincipalName </code><code>-like</code> <code>"$ServicePrincipalName"</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>foreach</code> <code>(</code><code>$MatchSPN</code> <code>in</code> <code>$MatchedSPNs</code><code>)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$MatchSamAccountName</code> <code>= </code><code>$MatchSPN</code><code>.SamAccountName</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>if</code> <code>(</code><code>$MatchSamAccountName</code> <code>-ne</code> <code>$SamAccountName</code><code>)</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>Write-Error</code> <code>"Duplicated SPN has been found for $ServicePrincipalName!!!"</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>else</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$Properties</code> <code>=&nbsp; @{</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"SamAccountName"</code> <code>= </code><code>$SamAccountName</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>"ServicePrincipalName"</code> <code>= </code><code>$ServicePrincipalName</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$SPNArrayRow</code> <code>= </code><code>New-Object</code> <code>PSObject</code> <code>-Property</code> <code>$Properties</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>$SPNArray</code> <code>+= </code><code>$SPNArrayRow</code></p><p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>&nbsp;&nbsp;&nbsp;</code><code>}</code></p><p><code>}</code></p></div></td></tr></tbody></table>

Please note that script can be running for a while in bigger environments as filtering all objects with SPNs takes some time.  
Script is not using standard SPN cmdlet **setspn** as it is always better to use PowerShell command instead of command line tool (at least in my humble opinion ;).

Hope it will be usefull for some of you ðŸ˜‰  
Enjoy!