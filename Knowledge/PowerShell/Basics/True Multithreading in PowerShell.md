As with all things, the longer you play with something the more you learn about it. It has been nearly 5 years since I wrote my [original article][1] on multithreading where I used PowerShell jobs to run multiple items at a time. In the conversations following that post I had a reader submit a fairly nasty note saying that multithreading with jobs was in fact not real multithreading. He also selected some choice words for me making sure I couldn’t post his comments. It hurt my very fragile feelings and, as a result, I started looking at how I could really, truly multithread with PowerShell. The result of that effort is this script. This is a true multithreading script no “ifs”, “ands” or “buts”.

It runs MUCH faster than my other rendition and includes a much more advanced feature set from my other script. The down side is that the script is very difficult to understand if you are new to PowerShell. If you would like to have a script that is more visible and easier to understand, please refer to the [version that uses Jobs][2].

Okay, so the big addition for this script is the ability to either run a script or a cmdlet that’s built in. As well, you can run this within the pipeline! To do that I had to include the begin, process and end blocks. It makes the script a bit more complex, but really pays off when you pipe your custom script into Out-Gridview or pipe your advanced filtering script into a multithreaded one! I have even pulled my SCCM collections via Get-WmiObject and piped them into a multithreaded script! Cool stuff!

Okay, so on to the breakdown.

First we need to get all of our parameters. If this doesn’t make since, please find my post on [parameters][3]!

PowerShell

Param($Command = $(Read-Host "Enter the script file"), \[Parameter(ValueFromPipeline=$true,ValueFromPipelineByPropertyName=$true)\]$ObjectList, $InputParam = $Null, $MaxThreads = 20, $SleepTimer = 200, $MaxResultTime = 120, \[HashTable\]$AddParam = @{}, \[Array\]$AddSwitch = @() )

<table class="crayon-table" style=""><tbody><tr class="urvanov-syntax-highlighter-row"><td class="crayon-nums " data-settings="show"><div class="urvanov-syntax-highlighter-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5366414941570-1">1</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5366414941570-2">2</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5366414941570-3">3</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5366414941570-4">4</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5366414941570-5">5</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5366414941570-6">6</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5366414941570-7">7</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5366414941570-8">8</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5366414941570-9">9</div></div></td><td class="urvanov-syntax-highlighter-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5366414941570-1"><span class="crayon-st">Param</span><span class="crayon-sy">(</span><span class="crayon-v">$Command</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r ">Read-Host</span><span class="crayon-h"> </span><span class="crayon-s">"Enter the script file"</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"></span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5366414941570-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">Parameter</span><span class="crayon-sy">(</span><span class="crayon-i">ValueFromPipeline</span><span class="crayon-o">=</span><span class="crayon-v">$true</span><span class="crayon-sy">,</span><span class="crayon-i">ValueFromPipelineByPropertyName</span><span class="crayon-o">=</span><span class="crayon-v">$true</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span><span class="crayon-v">$ObjectList</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5366414941570-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$InputParam</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$Null</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5366414941570-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$MaxThreads</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span>20<span class="crayon-sy">,</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5366414941570-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$SleepTimer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span>200<span class="crayon-sy">,</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5366414941570-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$MaxResultTime</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span>120<span class="crayon-sy">,</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5366414941570-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-t">HashTable</span><span class="crayon-sy">]</span><span class="crayon-v">$AddParam</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">@</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5366414941570-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-t">Array</span><span class="crayon-sy">]</span><span class="crayon-v">$AddSwitch</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">@</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5366414941570-9"><span class="crayon-sy">)</span><span class="crayon-h"></span></div></div></td></tr></tbody></table>

All of these are defined as follows:  
**Command**  
This is where you provide the powershell Commandlet / Script file that you want to multithread. You can also choose a built in cmdlet. Keep in mind that your script. This script is read into a scriptblock, so any unforeseen errors are likely caused by the conversion to a script block.

**ObjectList**  
The objectlist represents the arguments that are provided to the child script. This is an open ended argument and can take a single object from the pipeline, an array, a collection, or a file name. The multithreading script does it’s best to find out which you have provided and handle it as such. If you would like to provide a file, then the file is read with one object on each line and will be provided as is to the script you are running as a string. If this is not desired, then use an array.

**InputParam**  
This allows you to specify the parameter for which your input objects are to be evaluated. As an example, if you were to provide a computer name to the Get-Process cmdlet as just an argument, it would attempt to find all processes where the name was the provided computer name and fail. You need to specify that the parameter that you are providing is the “ComputerName”.

**AddParam**  
This allows you to specify additional parameters to the running command. For instance, if you are trying to find the status of the “BITS” service on all servers in your list, you will need to specify the “Name” parameter. This command takes a hash pair formatted as follows:

PowerShell

@{"ParameterName" = "Value"} @{"ParameterName" = "Value" ; "ParameterTwo" = "Value2"}

<table class="crayon-table" style=""><tbody><tr class="urvanov-syntax-highlighter-row"><td class="crayon-nums " data-settings="show"><div class="urvanov-syntax-highlighter-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db536a043948415-1">1</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db536a043948415-2">2</div></div></td><td class="urvanov-syntax-highlighter-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db536a043948415-1"><span class="crayon-sy">@</span><span class="crayon-sy">{</span><span class="crayon-s">"ParameterName"</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"Value"</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db536a043948415-2"><span class="crayon-sy">@</span><span class="crayon-sy">{</span><span class="crayon-s">"ParameterName"</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"Value"</span><span class="crayon-h"> </span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-s">"ParameterTwo"</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"Value2"</span><span class="crayon-sy">}</span></div></div></td></tr></tbody></table>

**AddSwitch**  
This allows you to add additional switches to the command you are running. For instance, you may want to include “RequiredServices” to the “Get-Service” cmdlet. This parameter will take a single string, or an aray of strings as follows:

PowerShell

"RequiredServices" @("RequiredServices", "DependentServices")

<table class="crayon-table" style=""><tbody><tr class="urvanov-syntax-highlighter-row"><td class="crayon-nums " data-settings="show"><div class="urvanov-syntax-highlighter-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db536e896227757-1">1</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db536e896227757-2">2</div></div></td><td class="urvanov-syntax-highlighter-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db536e896227757-1"><span class="crayon-s">"RequiredServices"</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db536e896227757-2"><span class="crayon-sy">@</span><span class="crayon-sy">(</span><span class="crayon-s">"RequiredServices"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"DependentServices"</span><span class="crayon-sy">)</span></div></div></td></tr></tbody></table>

**MaxThreads**  
This is the maximum number of threads to run at any given time. If resources are too congested try lowering this number. The default value is 20.

**SleepTimer**  
This is the time between cycles of the child process detection cycle. The default value is 200ms. If CPU utilization is high then you can consider increasing this delay. If the child script takes a long time to run, then you might increase this value to around 1000 (or 1 second in the detection cycle).

Now we need to set everything up. This stuff needs to execute outside of the pipeline, so we place it in the “begin” block of the script.

PowerShell

Begin{ $ISS = \[system.management.automation.runspaces.initialsessionstate\]::CreateDefault() $RunspacePool = \[runspacefactory\]::CreateRunspacePool(1, $MaxThreads, $ISS, $Host) $RunspacePool.Open() If ($(Get-Command | Select-Object Name) -match $Command){ $Code = $Null }Else{ $OFS = "\`r\`n" $Code = \[ScriptBlock\]::Create($(Get-Content $Command)) Remove-Variable OFS } $Jobs = @() }

<table class="crayon-table" style=""><tbody><tr class="urvanov-syntax-highlighter-row"><td class="crayon-nums " data-settings="show"><div class="urvanov-syntax-highlighter-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5371678248886-1">1</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5371678248886-2">2</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5371678248886-3">3</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5371678248886-4">4</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5371678248886-5">5</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5371678248886-6">6</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5371678248886-7">7</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5371678248886-8">8</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5371678248886-9">9</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5371678248886-10">10</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5371678248886-11">11</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5371678248886-12">12</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5371678248886-13">13</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5371678248886-14">14</div></div></td><td class="urvanov-syntax-highlighter-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5371678248886-1"><span class="crayon-e">Begin</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5371678248886-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$ISS</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">system</span><span class="crayon-sy">.</span><span class="crayon-i">management</span><span class="crayon-sy">.</span><span class="crayon-i">automation</span><span class="crayon-sy">.</span><span class="crayon-i">runspaces</span><span class="crayon-sy">.</span><span class="crayon-i">initialsessionstate</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">CreateDefault</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5371678248886-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$RunspacePool</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">runspacefactory</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">CreateRunspacePool</span><span class="crayon-sy">(</span>1<span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">$MaxThreads</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">$ISS</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">$Host</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5371678248886-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$RunspacePool</span><span class="crayon-sy">.</span><span class="crayon-e">Open</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5371678248886-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5371678248886-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">If</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r ">Get-Command</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">Select-Object</span><span class="crayon-h"> </span><span class="crayon-i">Name</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-cn">-match</span><span class="crayon-h"> </span><span class="crayon-v">$Command</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5371678248886-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Code</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$Null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5371678248886-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-st">Else</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5371678248886-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$OFS</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"`r`n"</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5371678248886-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Code</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">ScriptBlock</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">Create</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r ">Get-Content</span><span class="crayon-h"> </span><span class="crayon-v">$Command</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5371678248886-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-r ">Remove-Variable</span><span class="crayon-h"> </span><span class="crayon-i">OFS</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5371678248886-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5371678248886-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Jobs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">@</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5371678248886-14"><span class="crayon-sy">}</span><span class="crayon-h"></span></div></div></td></tr></tbody></table>

Okay, so to break this down, first we need to make our ISS, or initial session state. This is basically the session state to be used when we open our Runspace. Next we create our Runspaces. The RunspacePool is really what’s going to do the multithreading. It will handle starting our threads and continuously start new ones as required. It is the operating environment for our command pipeline. Finally we open the RunSpacePool. Note that “.Open()” opens the RunSpacePool synchronously, creating a Windows PowerShell execution environment.

Now I am running a detection on what the user provided for the $command parameter. First I will look at all of the currently loaded cmdlets. If it is one of those, then we continue. Otherwise we assume it is a script file. If it is a script file then we need to read the file in to a script block that we can pass to our future threads. To do this we need to change the default $OFS (Object Field Separator), for more understanding here, please read my [other post][4]!

Okay, so the next step is to start receiving items from the pipeline. We can do this by starting the process block. Note that the process block is executed for each item we find in the pipeline. Meanwhile, if you did not execute in the pipeline it is executed once for the script as a whole. What this means is that we need to assume that $ObjectList will either be a single item or multiple items. The best way to do that is to use a ForEach Loop.

PowerShell

Process{ Write-Progress -Activity "Preloading threads" -Status "Starting Job $($jobs.count)" ForEach ($Object in $ObjectList){ If ($Code -eq $Null){ $PowershellThread = \[powershell\]::Create().AddCommand($Command) }Else{ $PowershellThread = \[powershell\]::Create().AddScript($Code) } If ($InputParam -ne $Null){ $PowershellThread.AddParameter($InputParam, $Object.ToString()) | out-null }Else{ $PowershellThread.AddArgument($Object.ToString()) | out-null } ForEach($Key in $AddParam.Keys){ $PowershellThread.AddParameter($Key, $AddParam.$key) | out-null } ForEach($Switch in $AddSwitch){ $Switch $PowershellThread.AddParameter($Switch) | out-null } $PowershellThread.RunspacePool = $RunspacePool $Handle = $PowershellThread.BeginInvoke() $Job = "" | Select-Object Handle, Thread, object $Job.Handle = $Handle $Job.Thread = $PowershellThread $Job.Object = $Object.ToString() $Jobs += $Job } }

<table class="crayon-table" style=""><tbody><tr class="urvanov-syntax-highlighter-row"><td class="crayon-nums " data-settings="show"><div class="urvanov-syntax-highlighter-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-1">1</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-2">2</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-3">3</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-4">4</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-5">5</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-6">6</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-7">7</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-8">8</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-9">9</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-10">10</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-11">11</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-12">12</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-13">13</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-14">14</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-15">15</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-16">16</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-17">17</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-18">18</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-19">19</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-20">20</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-21">21</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-22">22</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-23">23</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-24">24</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-25">25</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-26">26</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-27">27</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-28">28</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-29">29</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db5380073510598-30">30</div></div></td><td class="urvanov-syntax-highlighter-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-1"><span class="crayon-e">Process</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-r ">Write-Progress</span><span class="crayon-h"> </span><span class="crayon-cn">-Activity</span><span class="crayon-h"> </span><span class="crayon-s">"Preloading threads"</span><span class="crayon-h"> </span><span class="crayon-cn">-Status</span><span class="crayon-h"> </span><span class="crayon-s">"Starting Job $($jobs.count)"</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">ForEach</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">$Object</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">$ObjectList</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">If</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">$Code</span><span class="crayon-h"> </span><span class="crayon-cn">-eq</span><span class="crayon-h"> </span><span class="crayon-v">$Null</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$PowershellThread</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">powershell</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">Create</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">AddCommand</span><span class="crayon-sy">(</span><span class="crayon-v">$Command</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-st">Else</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$PowershellThread</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">powershell</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">Create</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">AddScript</span><span class="crayon-sy">(</span><span class="crayon-v">$Code</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">If</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">$InputParam</span><span class="crayon-h"> </span><span class="crayon-cn">-ne</span><span class="crayon-h"> </span><span class="crayon-v">$Null</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$PowershellThread</span><span class="crayon-sy">.</span><span class="crayon-e">AddParameter</span><span class="crayon-sy">(</span><span class="crayon-v">$InputParam</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">$Object</span><span class="crayon-sy">.</span><span class="crayon-e">ToString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">out-null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-st">Else</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$PowershellThread</span><span class="crayon-sy">.</span><span class="crayon-e">AddArgument</span><span class="crayon-sy">(</span><span class="crayon-v">$Object</span><span class="crayon-sy">.</span><span class="crayon-e">ToString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">out-null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">ForEach</span><span class="crayon-sy">(</span><span class="crayon-v">$Key</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">$AddParam</span><span class="crayon-sy">.</span><span class="crayon-i">Keys</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$PowershellThread</span><span class="crayon-sy">.</span><span class="crayon-e">AddParameter</span><span class="crayon-sy">(</span><span class="crayon-v">$Key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">$AddParam</span><span class="crayon-sy">.</span><span class="crayon-v">$key</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">out-null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">ForEach</span><span class="crayon-sy">(</span><span class="crayon-v">$Switch</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">$AddSwitch</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Switch</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$PowershellThread</span><span class="crayon-sy">.</span><span class="crayon-e">AddParameter</span><span class="crayon-sy">(</span><span class="crayon-v">$Switch</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">out-null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$PowershellThread</span><span class="crayon-sy">.</span><span class="crayon-i">RunspacePool</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$RunspacePool</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Handle</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$PowershellThread</span><span class="crayon-sy">.</span><span class="crayon-e">BeginInvoke</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">Select-Object</span><span class="crayon-h"> </span><span class="crayon-i">Handle</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">Thread</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">object</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-i">Handle</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$Handle</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-i">Thread</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$PowershellThread</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$Object</span><span class="crayon-sy">.</span><span class="crayon-e">ToString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Jobs</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-v">$Job</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db5380073510598-30"><span class="crayon-sy">}</span><span class="crayon-h"></span></div></div></td></tr></tbody></table>

So now we have to build the thread that we are going to execute. We do this by adding either the command, or the script. The first IF block is to determine which. A thread either takes an existing PowerShell command, or a Scriptblock. If you remember we built this out in the Begin statement above. Once that is done we need to start giving the user the power to control the item we are calling.

First things first we look at $InputParam. This is what allows the user to execute the child script not just with the argument provided, but also specify the parameter. We see this is useful with the Get-Process cmdlet. Let’s say that you want to see the processes running on 20 different servers. If you just ran Get-Process ServerName you would be looking at your local machine for any processes with the name “ServerName” and you would get no return (probably). Instead you would want to run Get-Process –ComputerName ServerName. The trick here is that when you do this you’ve actually changed things! When an item is just hanging at the end of the statement, it is called an Argument. When you pair the item you are setting with the setting it is called a Parameter. So if the user wants to specify the parameter name, we are actually adding a different item to our thread!

Now we need to see if the user wanted to add some extra parameters. For this I decided that a hash table was perfect. This is because they are built much like a parameter, as they are name / value pairs. The user can provide as many as they want in a single hash table, and we can easily run a ForEach to evaluate this. Again we are going to use the .AddParameter() statement to evaluate.

Finally we need to add any Switches that the user wants to add. A good example of this is the –Force switch on cmdlets like Get-ChildItem. We can do this with an array of string which again allows the user to put in as many various switches as they like. One interesting not here is that I had to use .AddParameter() for this as well. Instead of creating a method called .AddSwitch(), Microsoft simply chose to add an overloaded definition of .AddParameter(). What’s peculiar is that even in their documentation (link below) it does in fact say that providing just a string adds a switch instead of parameter.

Now that we have out thread all set up we simply attach our RunspacePool that we setup in the begin statement, and then tell it to execute our thread!

To avoid having a thread hanging around that we lose track of we need to try to do some tracking here. To do this we first catch the thread by creating the output of the command in a $Handle variable. This will provide the link back to the handle in our “End” block. I then go ahead and create a custom object which I have named $Job to hold all these little gems of knowledge. Then I add my custom object to the array for tracking called $Jobs. This method of creating objects was taught to me by my reader from [this post][5]!

At this point all of the code to start the jobs is complete! Now we just have to grab all of the jobs back. That calls for the “End” block which is executed once per script run. Since that is the case, we need one main loop to ensure that it stay running while we need it to. Within the “End” block we will watch for jobs to finish and provide that output as they complete.

PowerShell

End{ $ResultTimer = Get-Date While (@($Jobs | Where-Object {$\_.Handle -ne $Null}).count -gt 0) { $Remaining = "$($($Jobs | Where-Object {$\_.Handle.IsCompleted -eq $False}).object)" If ($Remaining.Length -gt 60){ $Remaining = $Remaining.Substring(0,60) + "..." } Write-Progress \` -Activity "Waiting for Jobs - $($MaxThreads - $($RunspacePool.GetAvailableRunspaces())) of $MaxThreads threads running" \` -PercentComplete (($Jobs.count - $($($Jobs | Where-Object {$\_.Handle.IsCompleted -eq $False}).count)) / $Jobs.Count \* 100) \` -Status "$(@($($Jobs | Where-Object {$\_.Handle.IsCompleted -eq $False})).count) remaining - $remaining" ForEach ($Job in $($Jobs | Where-Object {$\_.Handle.IsCompleted -eq $True})){ $Job.Thread.EndInvoke($Job.Handle) $Job.Thread.Dispose() $Job.Thread = $Null $Job.Handle = $Null $ResultTimer = Get-Date } If (($(Get-Date) - $ResultTimer).totalseconds -gt $MaxResultTime){ Write-Error "Child script appears to be frozen, try increasing MaxResultTime" Exit } Start-Sleep -Milliseconds $SleepTimer } $RunspacePool.Close() | Out-Null $RunspacePool.Dispose() | Out-Null }

<table class="crayon-table" style=""><tbody><tr class="urvanov-syntax-highlighter-row"><td class="crayon-nums " data-settings="show"><div class="urvanov-syntax-highlighter-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-1">1</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-2">2</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-3">3</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-4">4</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-5">5</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-6">6</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-7">7</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-8">8</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-9">9</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-10">10</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-11">11</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-12">12</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-13">13</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-14">14</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-15">15</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-16">16</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-17">17</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-18">18</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-19">19</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-20">20</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-21">21</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-22">22</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-23">23</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-24">24</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-25">25</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-26">26</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-27">27</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-28">28</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-29">29</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53a0080645676-30">30</div></div></td><td class="urvanov-syntax-highlighter-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-1"><span class="crayon-e">End</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$ResultTimer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r ">Get-Date</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">While</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">@</span><span class="crayon-sy">(</span><span class="crayon-v">$Jobs</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">Where-Object</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">$_</span><span class="crayon-sy">.</span><span class="crayon-i">Handle</span><span class="crayon-h"> </span><span class="crayon-cn">-ne</span><span class="crayon-h"> </span><span class="crayon-v">$Null</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-i">count</span><span class="crayon-h"> </span><span class="crayon-cn">-gt</span><span class="crayon-h"> </span>0<span class="crayon-sy">)</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Remaining</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"$($($Jobs | Where-Object {$_.Handle.IsCompleted -eq $False}).object)"</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">If</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">$Remaining</span><span class="crayon-sy">.</span><span class="crayon-i">Length</span><span class="crayon-h"> </span><span class="crayon-cn">-gt</span><span class="crayon-h"> </span>60<span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Remaining</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$Remaining</span><span class="crayon-sy">.</span><span class="crayon-e">Substring</span><span class="crayon-sy">(</span>0<span class="crayon-sy">,</span>60<span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"..."</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-r ">Write-Progress</span><span class="crayon-h"> </span><span class="crayon-sy">`</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">-Activity</span><span class="crayon-h"> </span><span class="crayon-s">"Waiting for Jobs - $($MaxThreads - $($RunspacePool.GetAvailableRunspaces())) of $MaxThreads threads running"</span><span class="crayon-h"> </span><span class="crayon-sy">`</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">-PercentComplete</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">$Jobs</span><span class="crayon-sy">.</span><span class="crayon-i">count</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-v">$Jobs</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">Where-Object</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">$_</span><span class="crayon-sy">.</span><span class="crayon-i">Handle</span><span class="crayon-sy">.</span><span class="crayon-i">IsCompleted</span><span class="crayon-h"> </span><span class="crayon-cn">-eq</span><span class="crayon-h"> </span><span class="crayon-v">$False</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-i">count</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-v">$Jobs</span><span class="crayon-sy">.</span><span class="crayon-i">Count</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span>100<span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">`</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">-Status</span><span class="crayon-h"> </span><span class="crayon-s">"$(@($($Jobs | Where-Object {$_.Handle.IsCompleted -eq $False})).count) remaining - $remaining"</span><span class="crayon-h"></span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-13">&nbsp;</div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">ForEach</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">$Job</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-v">$Jobs</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">Where-Object</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">$_</span><span class="crayon-sy">.</span><span class="crayon-i">Handle</span><span class="crayon-sy">.</span><span class="crayon-i">IsCompleted</span><span class="crayon-h"> </span><span class="crayon-cn">-eq</span><span class="crayon-h"> </span><span class="crayon-v">$True</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-i">Thread</span><span class="crayon-sy">.</span><span class="crayon-e">EndInvoke</span><span class="crayon-sy">(</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-i">Handle</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-i">Thread</span><span class="crayon-sy">.</span><span class="crayon-e">Dispose</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-i">Thread</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$Null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-i">Handle</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$Null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$ResultTimer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r ">Get-Date</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">If</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r ">Get-Date</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">$ResultTimer</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-i">totalseconds</span><span class="crayon-h"> </span><span class="crayon-cn">-gt</span><span class="crayon-h"> </span><span class="crayon-v">$MaxResultTime</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-r ">Write-Error</span><span class="crayon-h"> </span><span class="crayon-s">"Child script appears to be frozen, try increasing MaxResultTime"</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">Exit</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-r ">Start-Sleep</span><span class="crayon-h"> </span><span class="crayon-cn">-Milliseconds</span><span class="crayon-h"> </span><span class="crayon-v">$SleepTimer</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"></span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$RunspacePool</span><span class="crayon-sy">.</span><span class="crayon-e">Close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">Out-Null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$RunspacePool</span><span class="crayon-sy">.</span><span class="crayon-e">Dispose</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">Out-Null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53a0080645676-30"><span class="crayon-sy">}</span><span class="crayon-h"></span></div></div></td></tr></tbody></table>

The first part of this is simply to provide some form of pretty output. First, I evaluate what jobs are still running and creating a string (truncated) that names them. I added this so that if the child script is failing on just one or two servers, you will known which they are to fix them. Then a rather complex write-progress statement which I’ll let you look into. For More info on write-progress you can read my blog articles over [write-progress][6] or [getting the progress of a child job][7].

Okay, so now we look for jobs that are completed. We can do this by looking into our array of objects where our handle (that we captured above) has .IsCompleted set to $true! We then run a ForEach on each of these to stop it running and dispose of it. Keep in mind that dispose returns all of the output from the thread. What this means is that the script will actually write all of the output as jobs are finished instead of having to wait for all jobs to finish!

Next I added some protection to the script. I had a couple of scripts in my arsenal that would lock up and never finish. When this happened the multithreading script would continue to run and loop forever and ever. To stop this I added a maximum time to wait for additional jobs to finish. To do this I simply look at the system clock for when the last job completed and look at the time gap. If it is greater than out parameter for $MaxResultTime then we’ll throw an error and exit. Note that until PowerShell actually closes those threads will continue to hang around!

As a very last step we clean up our $RunspacePool.

Well that’s all folks! I really hope that this script provide many time saving events for my wonderful readers. I know it has saved me hundreds of man hours!

Following is the full script with the comment block intact for your cutting and pasting pleasure! Note that you can use the advanced controls here to pop out to a new window or show plain code for copy and paste.

PowerShell

#.Synopsis # This is a quick and open-ended script multi-threader searcher # #.Description # This script will allow any general, external script to be multithreaded by providing a single # argument to that script and opening it in a seperate thread. It works as a filter in the # pipeline, or as a standalone script. It will read the argument either from the pipeline # or from a filename provided. It will send the results of the child script down the pipeline, # so it is best to use a script that returns some sort of object. # # Authored by Ryan Witschger - http://www.Get-Blog.com # #.PARAMETER Command # This is where you provide the PowerShell Cmdlet / Script file that you want to multithread. # You can also choose a built in cmdlet. Keep in mind that your script. This script is read into # a scriptblock, so any unforeseen errors are likely caused by the conversion to a script block. # #.PARAMETER ObjectList # The objectlist represents the arguments that are provided to the child script. This is an open ended # argument and can take a single object from the pipeline, an array, a collection, or a file name. The # multithreading script does it's best to find out which you have provided and handle it as such. # If you would like to provide a file, then the file is read with one object on each line and will # be provided as is to the script you are running as a string. If this is not desired, then use an array. # #.PARAMETER InputParam # This allows you to specify the parameter for which your input objects are to be evaluated. As an example, # if you were to provide a computer name to the Get-Process cmdlet as just an argument, it would attempt to # find all processes where the name was the provided computername and fail. You need to specify that the # parameter that you are providing is the "ComputerName". # #.PARAMETER AddParam # This allows you to specify additional parameters to the running command. For instance, if you are trying # to find the status of the "BITS" service on all servers in your list, you will need to specify the "Name" # parameter. This command takes a hash pair formatted as follows: # # @{"ParameterName" = "Value"} # @{"ParameterName" = "Value" ; "ParameterTwo" = "Value2"} # #.PARAMETER AddSwitch # This allows you to add additional switches to the command you are running. For instance, you may want # to include "RequiredServices" to the "Get-Service" cmdlet. This parameter will take a single string, or # an aray of strings as follows: # # "RequiredServices" # @("RequiredServices", "DependentServices") # #.PARAMETER MaxThreads # This is the maximum number of threads to run at any given time. If resources are too congested try lowering # this number. The default value is 20. # #.PARAMETER SleepTimer # This is the time between cycles of the child process detection cycle. The default value is 200ms. If CPU # utilization is high then you can consider increasing this delay. If the child script takes a long time to # run, then you might increase this value to around 1000 (or 1 second in the detection cycle). # # #.EXAMPLE # Both of these will execute the script named ServerInfo.ps1 and provide each of the server names in AllServers.txt # while providing the results to the screen. The results will be the output of the child script. # # gc AllServers.txt | .\\Run-CommandMultiThreaded.ps1 -Command .\\ServerInfo.ps1 # .\\Run-CommandMultiThreaded.ps1 -Command .\\ServerInfo.ps1 -ObjectList (gc .\\AllServers.txt) # #.EXAMPLE # The following demonstrates the use of the AddParam statement # # $ObjectList | .\\Run-CommandMultiThreaded.ps1 -Command "Get-Service" -InputParam ComputerName -AddParam @{"Name" = "BITS"} # #.EXAMPLE # The following demonstrates the use of the AddSwitch statement # # $ObjectList | .\\Run-CommandMultiThreaded.ps1 -Command "Get-Service" -AddSwitch @("RequiredServices", "DependentServices") # #.EXAMPLE # The following demonstrates the use of the script in the pipeline # # $ObjectList | .\\Run-CommandMultiThreaded.ps1 -Command "Get-Service" -InputParam ComputerName -AddParam @{"Name" = "BITS"} | Select Status, MachineName # Param($Command = $(Read-Host "Enter the script file"), \[Parameter(ValueFromPipeline=$true,ValueFromPipelineByPropertyName=$true)\]$ObjectList, $InputParam = $Null, $MaxThreads = 20, $SleepTimer = 200, $MaxResultTime = 120, \[HashTable\]$AddParam = @{}, \[Array\]$AddSwitch = @() ) Begin{ $ISS = \[system.management.automation.runspaces.initialsessionstate\]::CreateDefault() $RunspacePool = \[runspacefactory\]::CreateRunspacePool(1, $MaxThreads, $ISS, $Host) $RunspacePool.Open() If ($(Get-Command | Select-Object Name) -match $Command){ $Code = $Null }Else{ $OFS = "\`r\`n" $Code = \[ScriptBlock\]::Create($(Get-Content $Command)) Remove-Variable OFS } $Jobs = @() } Process{ Write-Progress -Activity "Preloading threads" -Status "Starting Job $($jobs.count)" ForEach ($Object in $ObjectList){ If ($Code -eq $Null){ $PowershellThread = \[powershell\]::Create().AddCommand($Command) }Else{ $PowershellThread = \[powershell\]::Create().AddScript($Code) } If ($InputParam -ne $Null){ $PowershellThread.AddParameter($InputParam, $Object.ToString()) | out-null }Else{ $PowershellThread.AddArgument($Object.ToString()) | out-null } ForEach($Key in $AddParam.Keys){ $PowershellThread.AddParameter($Key, $AddParam.$key) | out-null } ForEach($Switch in $AddSwitch){ $Switch $PowershellThread.AddParameter($Switch) | out-null } $PowershellThread.RunspacePool = $RunspacePool $Handle = $PowershellThread.BeginInvoke() $Job = "" | Select-Object Handle, Thread, object $Job.Handle = $Handle $Job.Thread = $PowershellThread $Job.Object = $Object.ToString() $Jobs += $Job } } End{ $ResultTimer = Get-Date While (@($Jobs | Where-Object {$\_.Handle -ne $Null}).count -gt 0) { $Remaining = "$($($Jobs | Where-Object {$\_.Handle.IsCompleted -eq $False}).object)" If ($Remaining.Length -gt 60){ $Remaining = $Remaining.Substring(0,60) + "..." } Write-Progress \` -Activity "Waiting for Jobs - $($MaxThreads - $($RunspacePool.GetAvailableRunspaces())) of $MaxThreads threads running" \` -PercentComplete (($Jobs.count - $($($Jobs | Where-Object {$\_.Handle.IsCompleted -eq $False}).count)) / $Jobs.Count \* 100) \` -Status "$(@($($Jobs | Where-Object {$\_.Handle.IsCompleted -eq $False})).count) remaining - $remaining" ForEach ($Job in $($Jobs | Where-Object {$\_.Handle.IsCompleted -eq $True})){ $Job.Thread.EndInvoke($Job.Handle) $Job.Thread.Dispose() $Job.Thread = $Null $Job.Handle = $Null $ResultTimer = Get-Date } If (($(Get-Date) - $ResultTimer).totalseconds -gt $MaxResultTime){ Write-Error "Child script appears to be frozen, try increasing MaxResultTime" Exit } Start-Sleep -Milliseconds $SleepTimer } $RunspacePool.Close() | Out-Null $RunspacePool.Dispose() | Out-Null }

<table class="crayon-table" style=""><tbody><tr class="urvanov-syntax-highlighter-row"><td class="crayon-nums " data-settings="show"><div class="urvanov-syntax-highlighter-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-1">1</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-2">2</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-3">3</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-4">4</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-5">5</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-6">6</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-7">7</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-8">8</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-9">9</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-10">10</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-11">11</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-12">12</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-13">13</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-14">14</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-15">15</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-16">16</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-17">17</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-18">18</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-19">19</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-20">20</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-21">21</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-22">22</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-23">23</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-24">24</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-25">25</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-26">26</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-27">27</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-28">28</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-29">29</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-30">30</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-31">31</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-32">32</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-33">33</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-34">34</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-35">35</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-36">36</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-37">37</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-38">38</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-39">39</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-40">40</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-41">41</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-42">42</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-43">43</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-44">44</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-45">45</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-46">46</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-47">47</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-48">48</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-49">49</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-50">50</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-51">51</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-52">52</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-53">53</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-54">54</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-55">55</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-56">56</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-57">57</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-58">58</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-59">59</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-60">60</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-61">61</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-62">62</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-63">63</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-64">64</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-65">65</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-66">66</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-67">67</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-68">68</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-69">69</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-70">70</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-71">71</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-72">72</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-73">73</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-74">74</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-75">75</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-76">76</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-77">77</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-78">78</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-79">79</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-80">80</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-81">81</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-82">82</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-83">83</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-84">84</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-85">85</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-86">86</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-87">87</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-88">88</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-89">89</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-90">90</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-91">91</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-92">92</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-93">93</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-94">94</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-95">95</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-96">96</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-97">97</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-98">98</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-99">99</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-100">100</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-101">101</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-102">102</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-103">103</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-104">104</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-105">105</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-106">106</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-107">107</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-108">108</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-109">109</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-110">110</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-111">111</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-112">112</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-113">113</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-114">114</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-115">115</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-116">116</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-117">117</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-118">118</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-119">119</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-120">120</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-121">121</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-122">122</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-123">123</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-124">124</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-125">125</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-126">126</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-127">127</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-128">128</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-129">129</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-130">130</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-131">131</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-132">132</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-133">133</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-134">134</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-135">135</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-136">136</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-137">137</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-138">138</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-139">139</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-140">140</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-141">141</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-142">142</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-143">143</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-144">144</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-145">145</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-146">146</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-147">147</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-148">148</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-149">149</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-150">150</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-151">151</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-152">152</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-153">153</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-154">154</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-155">155</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-156">156</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-157">157</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-158">158</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-159">159</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-160">160</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-161">161</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-162">162</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-163">163</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-164">164</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-165">165</div><div class="crayon-num" data-line="urvanov-syntax-highlighter-65042b9db53af990438072-166">166</div></div></td><td class="urvanov-syntax-highlighter-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-1"><span class="crayon-c">#.Synopsis</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-2"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;This is a quick and open-ended script multi-threader searcher</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-3"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-4"><span class="crayon-c">#.Description</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-5"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;This script will allow any general, external script to be multithreaded by providing a single</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-6"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;argument to that script and opening it in a seperate thread.&nbsp;&nbsp;It works as a filter in the</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-7"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;pipeline, or as a standalone script.&nbsp;&nbsp;It will read the argument either from the pipeline</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-8"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;or from a filename provided.&nbsp;&nbsp;It will send the results of the child script down the pipeline,</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-9"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;so it is best to use a script that returns some sort of object.</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-10"><span class="crayon-c">#</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-11"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;Authored by Ryan Witschger - http://www.Get-Blog.com</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-12"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-13"><span class="crayon-c">#.PARAMETER Command</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-14"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;This is where you provide the PowerShell Cmdlet / Script file that you want to multithread.&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-15"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;You can also choose a built in cmdlet.&nbsp;&nbsp;Keep in mind that your script.&nbsp;&nbsp;This script is read into</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-16"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;a scriptblock, so any unforeseen errors are likely caused by the conversion to a script block.</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-17"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-18"><span class="crayon-c">#.PARAMETER ObjectList</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-19"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;The objectlist represents the arguments that are provided to the child script.&nbsp;&nbsp;This is an open ended</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-20"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;argument and can take a single object from the pipeline, an array, a collection, or a file name.&nbsp;&nbsp;The</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-21"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;multithreading script does it's best to find out which you have provided and handle it as such.&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-22"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;If you would like to provide a file, then the file is read with one object on each line and will</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-23"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;be provided as is to the script you are running as a string.&nbsp;&nbsp;If this is not desired, then use an array.</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-24"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-25"><span class="crayon-c">#.PARAMETER InputParam</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-26"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;This allows you to specify the parameter for which your input objects are to be evaluated.&nbsp;&nbsp;As an example,</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-27"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;if you were to provide a computer name to the Get-Process cmdlet as just an argument, it would attempt to</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-28"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;find all processes where the name was the provided computername and fail.&nbsp;&nbsp;You need to specify that the</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-29"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;parameter that you are providing is the "ComputerName".</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-30"><span class="crayon-c">#</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-31"><span class="crayon-c">#.PARAMETER AddParam</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-32"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;This allows you to specify additional parameters to the running command.&nbsp;&nbsp;For instance, if you are trying</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-33"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;to find the status of the "BITS" service on all servers in your list, you will need to specify the "Name"</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-34"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;parameter.&nbsp;&nbsp;This command takes a hash pair formatted as follows:&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-35"><span class="crayon-c">#</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-36"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;@{"ParameterName" = "Value"}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-37"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;@{"ParameterName" = "Value" ; "ParameterTwo" = "Value2"}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-38"><span class="crayon-c">#</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-39"><span class="crayon-c">#.PARAMETER AddSwitch</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-40"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;This allows you to add additional switches to the command you are running.&nbsp;&nbsp;For instance, you may want</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-41"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;to include "RequiredServices" to the "Get-Service" cmdlet.&nbsp;&nbsp;This parameter will take a single string, or</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-42"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;an aray of strings as follows:</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-43"><span class="crayon-c">#</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-44"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;"RequiredServices"</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-45"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;@("RequiredServices", "DependentServices")</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-46"><span class="crayon-c">#</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-47"><span class="crayon-c">#.PARAMETER MaxThreads</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-48"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;This is the maximum number of threads to run at any given time.&nbsp;&nbsp;If resources are too congested try lowering</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-49"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;this number.&nbsp;&nbsp;The default value is 20.</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-50"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-51"><span class="crayon-c">#.PARAMETER SleepTimer</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-52"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;This is the time between cycles of the child process detection cycle.&nbsp;&nbsp;The default value is 200ms.&nbsp;&nbsp;If CPU</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-53"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;utilization is high then you can consider increasing this delay.&nbsp;&nbsp;If the child script takes a long time to</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-54"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;run, then you might increase this value to around 1000 (or 1 second in the detection cycle).</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-55"><span class="crayon-c">#</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-56"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-57"><span class="crayon-c">#.EXAMPLE</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-58"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;Both of these will execute the script named ServerInfo.ps1 and provide each of the server names in AllServers.txt</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-59"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;while providing the results to the screen.&nbsp;&nbsp;The results will be the output of the child script.</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-60"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-61"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;gc AllServers.txt | .\Run-CommandMultiThreaded.ps1 -Command .\ServerInfo.ps1</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-62"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;.\Run-CommandMultiThreaded.ps1 -Command .\ServerInfo.ps1 -ObjectList (gc .\AllServers.txt)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-63"><span class="crayon-c">#</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-64"><span class="crayon-c">#.EXAMPLE</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-65"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;The following demonstrates the use of the AddParam statement</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-66"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-67"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;$ObjectList | .\Run-CommandMultiThreaded.ps1 -Command "Get-Service" -InputParam ComputerName -AddParam @{"Name" = "BITS"}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-68"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-69"><span class="crayon-c">#.EXAMPLE</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-70"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;The following demonstrates the use of the AddSwitch statement</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-71"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-72"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;$ObjectList | .\Run-CommandMultiThreaded.ps1 -Command "Get-Service" -AddSwitch @("RequiredServices", "DependentServices")</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-73"><span class="crayon-c">#</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-74"><span class="crayon-c">#.EXAMPLE</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-75"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;The following demonstrates the use of the script in the pipeline</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-76"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-77"><span class="crayon-c">#&nbsp;&nbsp;&nbsp;&nbsp;$ObjectList | .\Run-CommandMultiThreaded.ps1 -Command "Get-Service" -InputParam ComputerName -AddParam @{"Name" = "BITS"} | Select Status, MachineName</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-78"><span class="crayon-c">#</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-79">&nbsp;</div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-80">&nbsp;</div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-81"><span class="crayon-st">Param</span><span class="crayon-sy">(</span><span class="crayon-v">$Command</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r ">Read-Host</span><span class="crayon-h"> </span><span class="crayon-s">"Enter the script file"</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"></span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-82"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-e">Parameter</span><span class="crayon-sy">(</span><span class="crayon-i">ValueFromPipeline</span><span class="crayon-o">=</span><span class="crayon-v">$true</span><span class="crayon-sy">,</span><span class="crayon-i">ValueFromPipelineByPropertyName</span><span class="crayon-o">=</span><span class="crayon-v">$true</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span><span class="crayon-v">$ObjectList</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-83"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$InputParam</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$Null</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-84"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$MaxThreads</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span>20<span class="crayon-sy">,</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-85"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$SleepTimer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span>200<span class="crayon-sy">,</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-86"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$MaxResultTime</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span>120<span class="crayon-sy">,</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-87"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-t">HashTable</span><span class="crayon-sy">]</span><span class="crayon-v">$AddParam</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">@</span><span class="crayon-sy">{</span><span class="crayon-sy">}</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-88"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">[</span><span class="crayon-t">Array</span><span class="crayon-sy">]</span><span class="crayon-v">$AddSwitch</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">@</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-89"><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-90">&nbsp;</div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-91"><span class="crayon-e">Begin</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-92"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$ISS</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">system</span><span class="crayon-sy">.</span><span class="crayon-i">management</span><span class="crayon-sy">.</span><span class="crayon-i">automation</span><span class="crayon-sy">.</span><span class="crayon-i">runspaces</span><span class="crayon-sy">.</span><span class="crayon-i">initialsessionstate</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">CreateDefault</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-93"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$RunspacePool</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">runspacefactory</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">CreateRunspacePool</span><span class="crayon-sy">(</span>1<span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">$MaxThreads</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">$ISS</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">$Host</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-94"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$RunspacePool</span><span class="crayon-sy">.</span><span class="crayon-e">Open</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-95"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-96"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">If</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r ">Get-Command</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">Select-Object</span><span class="crayon-h"> </span><span class="crayon-i">Name</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-cn">-match</span><span class="crayon-h"> </span><span class="crayon-v">$Command</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-97"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Code</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$Null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-98"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-st">Else</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-99"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$OFS</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"`r`n"</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-100"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Code</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">ScriptBlock</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">Create</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r ">Get-Content</span><span class="crayon-h"> </span><span class="crayon-v">$Command</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-101"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-r ">Remove-Variable</span><span class="crayon-h"> </span><span class="crayon-i">OFS</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-102"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-103"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Jobs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">@</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-104"><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-105">&nbsp;</div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-106"><span class="crayon-e">Process</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-107"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-r ">Write-Progress</span><span class="crayon-h"> </span><span class="crayon-cn">-Activity</span><span class="crayon-h"> </span><span class="crayon-s">"Preloading threads"</span><span class="crayon-h"> </span><span class="crayon-cn">-Status</span><span class="crayon-h"> </span><span class="crayon-s">"Starting Job $($jobs.count)"</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-108"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">ForEach</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">$Object</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">$ObjectList</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-109"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">If</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">$Code</span><span class="crayon-h"> </span><span class="crayon-cn">-eq</span><span class="crayon-h"> </span><span class="crayon-v">$Null</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-110"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$PowershellThread</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">powershell</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">Create</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">AddCommand</span><span class="crayon-sy">(</span><span class="crayon-v">$Command</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-111"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-st">Else</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-112"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$PowershellThread</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">powershell</span><span class="crayon-sy">]</span><span class="crayon-o">::</span><span class="crayon-e">Create</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">AddScript</span><span class="crayon-sy">(</span><span class="crayon-v">$Code</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-113"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-114"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">If</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">$InputParam</span><span class="crayon-h"> </span><span class="crayon-cn">-ne</span><span class="crayon-h"> </span><span class="crayon-v">$Null</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-115"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$PowershellThread</span><span class="crayon-sy">.</span><span class="crayon-e">AddParameter</span><span class="crayon-sy">(</span><span class="crayon-v">$InputParam</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">$Object</span><span class="crayon-sy">.</span><span class="crayon-e">ToString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">out-null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-116"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-st">Else</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-117"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$PowershellThread</span><span class="crayon-sy">.</span><span class="crayon-e">AddArgument</span><span class="crayon-sy">(</span><span class="crayon-v">$Object</span><span class="crayon-sy">.</span><span class="crayon-e">ToString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">out-null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-118"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-119"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">ForEach</span><span class="crayon-sy">(</span><span class="crayon-v">$Key</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">$AddParam</span><span class="crayon-sy">.</span><span class="crayon-i">Keys</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-120"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$PowershellThread</span><span class="crayon-sy">.</span><span class="crayon-e">AddParameter</span><span class="crayon-sy">(</span><span class="crayon-v">$Key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">$AddParam</span><span class="crayon-sy">.</span><span class="crayon-v">$key</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">out-null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-121"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-122"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">ForEach</span><span class="crayon-sy">(</span><span class="crayon-v">$Switch</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">$AddSwitch</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-123"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Switch</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-124"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$PowershellThread</span><span class="crayon-sy">.</span><span class="crayon-e">AddParameter</span><span class="crayon-sy">(</span><span class="crayon-v">$Switch</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">out-null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-125"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-126"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$PowershellThread</span><span class="crayon-sy">.</span><span class="crayon-i">RunspacePool</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$RunspacePool</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-127"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Handle</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$PowershellThread</span><span class="crayon-sy">.</span><span class="crayon-e">BeginInvoke</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-128"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">""</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">Select-Object</span><span class="crayon-h"> </span><span class="crayon-i">Handle</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">Thread</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">object</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-129"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-i">Handle</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$Handle</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-130"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-i">Thread</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$PowershellThread</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-131"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-t">Object</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$Object</span><span class="crayon-sy">.</span><span class="crayon-e">ToString</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-132"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Jobs</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-v">$Job</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-133"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-134"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-135"><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-136">&nbsp;</div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-137"><span class="crayon-e">End</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-138"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$ResultTimer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r ">Get-Date</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-139"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">While</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">@</span><span class="crayon-sy">(</span><span class="crayon-v">$Jobs</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">Where-Object</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">$_</span><span class="crayon-sy">.</span><span class="crayon-i">Handle</span><span class="crayon-h"> </span><span class="crayon-cn">-ne</span><span class="crayon-h"> </span><span class="crayon-v">$Null</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-i">count</span><span class="crayon-h"> </span><span class="crayon-cn">-gt</span><span class="crayon-h"> </span>0<span class="crayon-sy">)</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-140"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-141"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Remaining</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"$($($Jobs | Where-Object {$_.Handle.IsCompleted -eq $False}).object)"</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-142"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">If</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">$Remaining</span><span class="crayon-sy">.</span><span class="crayon-i">Length</span><span class="crayon-h"> </span><span class="crayon-cn">-gt</span><span class="crayon-h"> </span>60<span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-143"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Remaining</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$Remaining</span><span class="crayon-sy">.</span><span class="crayon-e">Substring</span><span class="crayon-sy">(</span>0<span class="crayon-sy">,</span>60<span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">"..."</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-144"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-145"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-r ">Write-Progress</span><span class="crayon-h"> </span><span class="crayon-sy">`</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-146"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">-Activity</span><span class="crayon-h"> </span><span class="crayon-s">"Waiting for Jobs - $($MaxThreads - $($RunspacePool.GetAvailableRunspaces())) of $MaxThreads threads running"</span><span class="crayon-h"> </span><span class="crayon-sy">`</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-147"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">-PercentComplete</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">$Jobs</span><span class="crayon-sy">.</span><span class="crayon-i">count</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-v">$Jobs</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">Where-Object</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">$_</span><span class="crayon-sy">.</span><span class="crayon-i">Handle</span><span class="crayon-sy">.</span><span class="crayon-i">IsCompleted</span><span class="crayon-h"> </span><span class="crayon-cn">-eq</span><span class="crayon-h"> </span><span class="crayon-v">$False</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-i">count</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-v">$Jobs</span><span class="crayon-sy">.</span><span class="crayon-i">Count</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span>100<span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">`</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-148"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">-Status</span><span class="crayon-h"> </span><span class="crayon-s">"$(@($($Jobs | Where-Object {$_.Handle.IsCompleted -eq $False})).count) remaining - $remaining"</span><span class="crayon-h"></span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-149">&nbsp;</div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-150"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">ForEach</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">$Job</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-v">$Jobs</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">Where-Object</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">$_</span><span class="crayon-sy">.</span><span class="crayon-i">Handle</span><span class="crayon-sy">.</span><span class="crayon-i">IsCompleted</span><span class="crayon-h"> </span><span class="crayon-cn">-eq</span><span class="crayon-h"> </span><span class="crayon-v">$True</span><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-151"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-i">Thread</span><span class="crayon-sy">.</span><span class="crayon-e">EndInvoke</span><span class="crayon-sy">(</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-i">Handle</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-152"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-i">Thread</span><span class="crayon-sy">.</span><span class="crayon-e">Dispose</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-153"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-i">Thread</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$Null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-154"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$Job</span><span class="crayon-sy">.</span><span class="crayon-i">Handle</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">$Null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-155"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$ResultTimer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r ">Get-Date</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-156"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-157"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">If</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">$</span><span class="crayon-sy">(</span><span class="crayon-r ">Get-Date</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">$ResultTimer</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-i">totalseconds</span><span class="crayon-h"> </span><span class="crayon-cn">-gt</span><span class="crayon-h"> </span><span class="crayon-v">$MaxResultTime</span><span class="crayon-sy">)</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-158"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-r ">Write-Error</span><span class="crayon-h"> </span><span class="crayon-s">"Child script appears to be frozen, try increasing MaxResultTime"</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-159"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">Exit</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-160"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-161"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-r ">Start-Sleep</span><span class="crayon-h"> </span><span class="crayon-cn">-Milliseconds</span><span class="crayon-h"> </span><span class="crayon-v">$SleepTimer</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-162"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-163"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"></span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-164"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$RunspacePool</span><span class="crayon-sy">.</span><span class="crayon-e">Close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">Out-Null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-165"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">$RunspacePool</span><span class="crayon-sy">.</span><span class="crayon-e">Dispose</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-r ">Out-Null</span></div><div class="crayon-line" id="urvanov-syntax-highlighter-65042b9db53af990438072-166"><span class="crayon-sy">}</span><span class="crayon-h"></span></div></div></td></tr></tbody></table>

Further Reading:  
Initial Session State:  
http://msdn.microsoft.com/en-us/library/system.management.automation.runspaces.initialsessionstate%28v=vs.85%29.aspx  
Runspaces:  
http://msdn.microsoft.com/en-us/library/System.Management.Automation.Runspaces.Runspace(v=vs.85).aspx  
PowerShell Class:  
http://msdn.microsoft.com/en-us/library/system.management.automation.powershell%28v=vs.85%29.aspx  
PowerShell AddParameter Method:  
http://msdn.microsoft.com/en-us/library/system.management.automation.powershell.addparameter%28v=vs.85%29.aspx

[1]: http://www.get-blog.com/?p=22
[2]: http://www.get-blog.com/?p=22
[3]: http://www.get-blog.com/?p=27
[4]: http://www.get-blog.com/?p=182
[5]: http://www.get-blog.com/?p=82
[6]: http://www.get-blog.com/?p=168
[7]: http://www.get-blog.com/?p=132